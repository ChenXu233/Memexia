# Memexia 实现方案大纲

> **版本**: v1.5.0
> **创建日期**: 2025-12-31
> **更新日期**: 2026-01-01
> **项目定位**: Rust核心引擎 + 文件即节点 + AI驱动知识图谱 + 可控AI思考脚手架 + 利用Git不重复造轮子
>
> **v1.5.0 更新**:
> - AI服务通过外部API接入（OpenAI/Anthropic/Ollama），本地仅RAG/向量化组件
> - AI工作流引擎插件化架构，支持自定义插件扩展
> - 移除 `memexia open` 命令，类似Git自动检测父目录 `.memexia`
> - 修正架构图：本地AI组件 → 外部LLM服务

---

## 零、思考演进 - 为什么是这个设计

> **"思想是连续的网络，不是孤立的文档"** —— Memexia 的设计源于对"思想如何演化"这个根本问题的持续追问。

### 0.1 从灵感萌芽到最终定位

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Memexia 设计思想演进时间线                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  阶段一：核心灵感（无限流博客）                                                │
│  从"工具替代人类" → "人类思考" → "情绪机制" → "进化目的" → 无限延伸           │
│  核心洞察：思想是连续的网络，不是孤立的文档                                     │
│  问题：现有工具（Obsidian、Roam）只支持简单链接，无法表达关系语义              │
│                                                                             │
│                              ▼                                               │
│                                                                             │
│  阶段二：技术构想（思想自动机）                                                │
│  类似数学推导：概念 → 推导 → 新概念 → 循环检测                                 │
│  目标：让思想像代码一样有版本、分支、合并                                      │
│  质疑：这是否在重新发明Git？                                                  │
│                                                                             │
│                              ▼                                               │
│                                                                             │
│  阶段三：务实转向（Git作为存储层）                                             │
│  关键洞察：利用Git，不重复造轮子                                               │
│  Git已完美解决：版本控制、分支、合并、同步                                     │
│  创新应在：思想的图结构和语义关系                                              │
│                                                                             │
│                              ▼                                               │
│                                                                             │
│  阶段四：核心突破（语义链接系统）                                              │
│  问题：[[链接]] 丢失了"为什么链接"的语义                                      │
│  解决方案：[[目标|关系类型]] 语法                                              │
│  15种预定义关系类型，支持自定义                                               │
│                                                                             │
│                              ▼                                               │
│                                                                             │
│  阶段五：重新定位（AI思考脚手架）                                              │
│  问题：LLM受限于上下文窗口，思考过程不透明                                     │
│  解决方案：三层架构（即时思考层 + 结构思考层 + 控制层）                        │
│  价值：让AI思考可检查、可修正、可控制                                          │
│                                                                             │
│                              ▼                                               │
│                                                                             │
│  阶段六：抗AGI设计（永恒价值）                                                │
│  长期思考：如何不被未来AGI淘汰？                                              │
│  核心价值：人机协同界面，而非AI能力本身                                        │
│  即使AGI能解决所有问题，人类仍需定义问题、确保价值、承担责任                   │
│  Memexia作为：控制面板、安全装置、责任框架                                     │
│                                                                             │
│                              ▼                                               │
│                                                                             │
│  阶段七：务实方案（最终定位）                                                 │
│  本地优先的个人知识图谱                                                       │
│  比Obsidian更强：有语义的关系系统                                             │
│  比Git更合适：思想粒度的版本控制                                              │
│  AI增强但可离线：本地嵌入模型优先                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 0.2 三个核心创新层

> Memexia 的设计围绕三个递进的创新层次展开：

#### 第一层：结构化思想表达

```
传统方式：                            Memexia 方式：
┌─────────────────┐                  ┌─────────────────┐
│ 自由意志        │                  │ 自由意志        │
│ [[链接]] 决定论 │     ──────>      │ --[CONTRICTS]-->│ 决定论
└─────────────────┘                  │ --[REFINES]---> │ 相容论
                                     └─────────────────┘

问题：纯文本丢失关系语义                方案：有类型、有权重、有方向的关系
                                          │
                                          ▼
                                    价值：机器可理解，AI可推理
```

#### 第二层：版本化思想图谱

```
类似Git，但针对思想：

┌─────────────────────────────────────────────────────────────────┐
│  Git           │  Memexia                                        │
├─────────────────────────────────────────────────────────────────┤
│  提交 = 代码快照 │  提交 = 思想状态快照                            │
│  分支 = 开发方向 │  分支 = 不同思考方向                            │
│  合并 = 整合代码 │  合并 = 整合不同观点                            │
│  冲突 = 合并冲突 │  冲突 = 逻辑矛盾处理                            │
├─────────────────────────────────────────────────────────────────┤
│  价值：追踪代码如何演化            价值：追踪思想如何演化           │
│                                   发现认知发展路径                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 第三层：可控AI思考扩展

```
┌─────────────────────────────────────────────────────────────────┐
│                     三层架构                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 控制层：人类干预和指导                                   │  │
│   │  • 定义什么问题该解决                                    │  │
│   │  • 确保解决方案符合价值观                                │  │
│   │  • 随时检查、修正、指导                                  │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ▲                                   │
│                              │                                   │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 结构思考层：图数据库存储中间推导                         │  │
│   │  • 突破LLM上下文限制                                     │  │
│   │  • 透明可追溯的推理路径                                  │  │
│   │  • 可信度计算与回退机制                                  │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ▲                                   │
│                              │                                   │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 即时思考层：LLM当前上下文                                │  │
│   │  • 快速响应                                              │  │
│   │  • 轻量级推理                                            │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│  价值：可信任的AI协作，而非黑盒AI                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 0.3 为什么需要这个设计

| 痛点 | 现有工具 | Memexia 解决方案 |
|------|---------|-----------------|
| 链接丢失语义 | Obsidian [[链接]] 无法表达关系 | [[目标\|类型]] 语法 |
| 思想碎片化 | 文档孤岛 | 图谱连接 + 语义关系 |
| AI是黑盒 | ChatGPT 过程不可见 | 三层架构 + 推导链追踪 |
| 难以回溯 | 不知道想法怎么来的 | 版本历史 + 推导链回退 |
| 价值单一 | 依赖AI能力 | 人机协同界面 |

---

## 一、核心理念

### 1.1 文件即节点，节点即文件

```
┌─────────────────────────────────────────────────────────────────┐
│                     核心设计原则                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户操作                    系统自动处理                         │
│  ┌─────────┐              ┌─────────────────────────────┐      │
│  │ 写文件   │ ──────────>  │ • 自动解析内容              │      │
│  └─────────┘              │ • 自动提取双向链接 [[xxx]]   │      │
│                           │ • 自动创建图节点              │      │
│                           │ • 自动建立连接边              │      │
│                           │ • 自动生成向量索引            │      │
│                           └─────────────────────────────┘      │
│                                                                 │
│  用户体验:                                                       │
│  • 无需学习节点/边命令                                            │
│  • 只需专注于创作内容                                              │
│  • 系统智能维护图谱结构                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 AI是灵魂

```
┌─────────────────────────────────────────────────────────────────┐
│                     AI驱动的知识探索                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │   RAG       │    │  自动链接   │    │ 节点生成    │        │
│  │  检索增强   │    │  智能发现   │    │  AI延伸     │        │
│  │  生成       │    │  连接       │    │  思想       │        │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘        │
│         │                  │                  │                 │
│         └──────────────────┼──────────────────┘                 │
│                            ▼                                     │
│                    ┌─────────────────┐                          │
│                    │   AI工作流引擎  │                          │
│                    │   自动化探索    │                          │
│                    └─────────────────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、项目架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Memexia Core                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐              │
│   │   CLI层      │     │   API层      │     │   同步层     │              │
│   │  (极简命令)  │     │  (REST/WS)   │     │  Git+GitHub  │              │
│   └──────┬───────┘     └──────┬───────┘     └──────┬───────┘              │
│          │                    │                    │                       │
│          └────────────────────┼────────────────────┘                       │
│                               ▼                                             │
│                    ┌─────────────────────┐                                  │
│                    │    Engine Core      │                                  │
│                    │   (libmemexia)      │                                  │
│                    └──────────┬──────────┘                                  │
│                               │                                              │
│          ┌────────────────────┼────────────────────┐                        │
│          ▼                    ▼                    ▼                        │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                 │
│   │  Git文件层  │     │   Graph     │     │   VCS       │                 │
│   │  (文件存储) │     │  (Oxigraph) │     │  (历史+推导)│                 │
│   └─────────────┘     └─────────────┘     └─────────────┘                 │
│                               │                                              │
│                               ▼                                              │
│                    ┌─────────────────────┐                                  │
│                    │  本地AI组件          │                                  │
│                    │  RAG/向量化/插件     │                                  │
│                    └──────────┬──────────┘                                  │
│                               │ (API调用)                                    │
│                               ▼                                              │
│                    ┌─────────────────────┐                                  │
│                    │  外部LLM服务         │                                  │
│                    │  OpenAI/Claude/     │                                  │
│                    │  Ollama(本地)        │                                  │
│                    └─────────────────────┘                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

接口层:
├── CLI: memexia {init,add,commit,graph,ai,serve,rollback,history...}
├── HTTP API: POST/GET /api/v1/* (RESTful + WebSocket)
└── IPC: Unix Socket / Named Pipe (可选)
```

---

## 三、模块划分与职责

### 3.1 核心模块 (src/core)

> **设计原则**: 文件即节点，无需显式节点操作

| 模块 | 文件 | 职责 |
|------|------|------|
| `repository.rs` | 仓库管理 | init, open, 配置加载 |
| `object.rs` | 对象存储 | Git式对象模型（blob/tree/commit） |
| `graph.rs` | 图操作 | SPARQL查询、遍历、分析、自动维护 |
| `parser.rs` | 内容解析 | Markdown解析、双向链接[[目标\|类型]]提取 |
| `indexer.rs` | 自动索引 | 文件变更监听、自动索引更新 |
| `watcher.rs` | 文件监听 | 监听文件变化，自动触发图更新 |

### 3.2 AI模块 (src/ai) - **可扩展插件架构**

> **核心设计**: AI服务通过API接入（外部LLM），本地仅轻量级RAG/向量化组件，工作流引擎支持插件扩展

| 模块 | 职责 | 说明 |
|------|------|------|
| `mod.rs` | AI服务抽象层 | 定义AI接口，支持多提供商（OpenAI/Anthropic/Ollama/本地模型） |
| `llm.rs` | LLM API适配器 | 调用外部LLM API，管理请求/响应 |
| `rag.rs` | **RAG检索增强** | 向量检索、上下文构建、本地索引管理 |
| `embeddings.rs` | 向量嵌入 | 生成节点/查询的向量表示（可本地或远程） |
| `linker.rs` | **自动链接发现** | AI分析内容，推荐潜在连接 |
| `generator.rs` | **节点自动生成** | 基于现有节点延伸新思想 |
| `workflow.rs` | **AI工作流引擎** | 插件化架构，支持自定义工作流类型 |
| `plugins/` | **插件系统** | 可扩展的AI工作流插件接口 |

#### 3.2.1 AI服务架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI服务架构                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  本地层 (Memexia Core)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  RAG/向量化组件                                                       │   │
│  │  • 向量索引 (FAISS/ChromaDB)                                         │   │
│  │  • 文本分块与编码                                                     │   │
│  │  • 上下文检索与组装                                                   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼ (API调用)                              │
│                                                                             │
│  远程层 (External AI Services)                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  LLM API (可配置提供商)                                               │   │
│  │  ├── OpenAI GPT-4/3.5                                                │   │
│  │  ├── Anthropic Claude                                               │   │
│  │  ├── Ollama (本地模型)                                               │   │
│  │  └── 自定义API兼容接口                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  插件层 (Plugins)                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  工作流插件接口                                                       │   │
│  │  • 探索性工作流插件                                                   │   │
│  │  • 论证分析工作流插件                                                 │   │
│  │  • 知识补全工作流插件                                                 │   │
│  │  • 自定义插件 (用户可扩展)                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 插件系统设计

```rust
// 插件trait定义 - 任何AI工作流都可以实现为插件
trait AiWorkflowPlugin: Send + Sync {
    /// 插件唯一标识符
    fn id(&self) -> &'static str;

    /// 插件名称
    fn name(&self) -> &'static str;

    /// 插件版本
    fn version(&self) -> &'static str;

    /// 执行工作流
    async fn execute(
        &self,
        context: &WorkflowContext,
        config: &PluginConfig
    ) -> Result<WorkflowResult, WorkflowError>;

    /// 验证配置
    fn validate_config(&self, config: &Value) -> Result<(), ValidationError>;
}

// 内置插件类型
enum BuiltInPlugin {
    Exploration,          // 探索性工作流
    ArgumentAnalysis,     // 论证分析工作流
    KnowledgeCompletion,  // 知识补全工作流
    Derivation,           // 推导性工作流
    Synthesis,            // 综合工作流
    Critique,             // 批判工作流
    Review,               // 定期回顾工作流
}

// 插件注册与发现
struct PluginManager {
    plugins: HashMap<&'static str, Box<dyn AiWorkflowPlugin>>,

    fn register(&mut self, plugin: Box<dyn AiWorkflowPlugin>);
    fn get(&self, id: &'static str) -> Option<&dyn AiWorkflowPlugin>;
    fn list(&self) -> Vec<PluginInfo>;
}
```

#### 3.2.3 配置示例

```json
{
  "ai": {
    "provider": "openai",  // 或 "anthropic", "ollama", "custom"
    "models": {
      "default": "gpt-4",
      "fast": "gpt-3.5-turbo"
    },
    "embedding": {
      "provider": "local",  // 本地向量模型
      "model": "BAAI/bge-small-zh"
    },
    "plugins": {
      "enabled": ["exploration", "argument-analysis", "synthesis"],
      "custom": []
    }
  }
}
```

### 3.3 存储模块 (src/storage)

| 模块 | 职责 |
|------|------|
| `mod.rs` | 存储抽象层，协调各存储后端 |
| `oxigraph.rs` | Oxigraph图数据库操作 |
| `sqlite.rs` | SQLite元数据存储 |
| `file.rs` | 文件系统操作、对象存储 |
| `vector.rs` | 向量索引（ChromaDB/FAISS/可选） |

### 3.4 版本控制模块 (src/vcs)

> **核心设计理念**: 混合架构 - Git存储文件 + 图数据库存储历史与推导链

| 模块 | 职责 |
|------|------|
| `mod.rs` | 版本控制抽象，协调Git与图历史 |
| `git.rs` | Git集成（文件存储、差异计算） |
| `commit.rs` | 提交操作、签名验证、多父提交 |
| `graph_history.rs` | 图历史追踪、节点快照、推导链 |
| `rollback.rs` | 快速回退（支持节点级别/AI推导链） |
| `pack.rs` | pack文件打包（优化传输） |

### 3.5 同步模块 (src/sync)

| 模块 | 职责 |
|------|------|
| `mod.rs` | 同步抽象 |
| `transport.rs` | 传输协议（HTTP/WebSocket） |
| `push.rs` | push操作 |
| `fetch.rs` | fetch操作 |
| `clone.rs` | clone完整仓库 |
| `conflict.rs` | 冲突检测与解决 |
| `remote.rs` | 远程仓库管理 |

### 3.6 API模块 (src/api)

| 模块 | 职责 |
|------|------|
| `mod.rs` | HTTP服务器框架 |
| `routes/` | RESTful路由 |
| `handlers/` | 请求处理器 |
| `models/` | API数据模型 |
| `websocket.rs` | WebSocket实时通信 |
| `auth.rs` | 认证与授权 |

### 3.7 CLI模块 (src/cli)

> **极简设计**: 用户只管文件，AI自动维护图谱

| 模块 | 职责 |
|------|------|
| `mod.rs` | CLI框架（clap） |
| `commands/` | 极简命令集 |
| `output/` | 格式化输出（ASCII图、JSON） |
| `interactive/` | 交互式输入 |

---

## 四、CLI命令规范

### 4.1 基础命令 - **极简至上**

```bash
# 仓库管理
memexia init [PATH]              # 初始化新仓库
memexia clone <URL> [PATH]       # 克隆远程仓库
memexia remote add <NAME> <URL>  # 添加远程仓库
memexia remote -v                # 列出远程仓库

# 自动检测：类似Git，系统自动向上查找 .memexia 目录
# 无需 "open" 命令，在仓库内执行任意命令即自动操作该仓库

# 文件操作 - **只需操作文件，节点自动创建**
memexia add <FILE...>            # 添加文件到暂存区
memexia status                   # 查看工作区状态
memexia commit -m "<MSG>"        # 提交变更
memexia commit --amend           # 修改最后一次提交
memexia reset [--soft|--hard]    # 重置工作区

# 版本历史
memexia log [--oneline|--graph]  # 查看提交历史
memexia show <COMMIT>            # 查看提交详情
memexia diff [COMMIT]            # 查看差异
```

### 4.2 图谱命令 - **自动维护**

```bash
# 图谱展示
memexia graph show [--json]                           # 输出图谱结构
memexia graph dot                                     # 输出DOT格式
memexia graph query "<SPARQL>"                        # SPARQL查询
memexia graph stats                                   # 图谱统计信息
memexia graph path <NODE1> <NODE2>                    # 查找两节点间的路径

# 查看节点/边 - **从文件角度查看**
memexia file <PATH>                                   # 查看文件对应的节点信息
memexia file links <PATH>                             # 查看文件中的链接
memexia file backlinks <PATH>                         # 查看文件的反向链接

# 手动链接命令 - **当需要手动创建链接时**
memexia link create <FILE> <TARGET> --type <TYPE>    # 手动创建链接（指定类型）
```

> **说明**: 无需 `memexia node/create/delete` 命令！
> - 创建文件 = 创建节点
> - 删除文件 = 删除节点
>
> **链接语法**: 使用 `[[目标节点|关系类型]]` 格式
> - `[[决定论|矛盾]]` - 创建"矛盾"类型的边
> - `[[意识|属于]]` - 创建"属于"类型的边
> - 系统解析时提取关系类型并创建对应边

### 4.3 **AI命令 - 核心功能**

```bash
# RAG 智能问答
memexia ask "<QUESTION>"                             # 基于图谱的智能问答
memexia ask --context <FILE> "<QUESTION>"            # 基于特定文件的问答

# 自动链接发现
memexia ai link suggest [FILE]                       # AI推荐潜在链接
memexia ai link auto [--dry-run]                     # 自动创建高置信度链接
memexia ai link review                               # 审查AI建议的链接

# 节点自动生成
memexia ai generate <FILE>                           # 基于文件延伸新思想
memexia ai generate --count 3 <FILE>                 # 生成多个新节点
memexia ai expand <TOPIC>                            # 展开主题的所有相关方向

# AI工作流
memexia ai workflow start <NAME>                     # 启动AI工作流
memexia ai workflow list                             # 列出运行中的工作流
memexia ai workflow stop <ID>                        # 停止工作流

# 向量搜索
memexia ai search "<QUERY>"                          # 语义搜索
memexia ai search --similar <FILE>                   # 查找相似节点
```

### 4.4 同步命令

```bash
memexia fetch [REMOTE]                  # 获取远程更新
memexia push <REMOTE>                   # 推送所有变更到远程
memexia pull <REMOTE>                   # 拉取并合并
memexia sync status                     # 同步状态
memexia sync conflicts                  # 查看冲突
memexia sync resolve <CONFLICT>         # 解决冲突
```

### 4.5 历史与回退命令

> **核心设计**: 历史记录类似Git - 只有正式提交才会记录，使用差异存储。

```bash
# 查看历史（类似Git）
memexia history                         # 查看当前历史
memexia history --oneline               # 简洁格式
memexia history --graph                 # 图形化展示
memexia history <COMMIT>                # 查看某次提交详情
memexia history <FILE>                  # 查看文件的变更历史

# 暂存区操作（类似Git Staging）
memexia status                          # 查看工作区状态
memexia add <FILE>                      # 暂存文件/节点
memexia add <CHAIN_ID>                  # 暂存推导链（AI生成）
memexia reset <FILE>                    # 从暂存区移除

# 提交（类似Git Commit）
memexia commit -m "message"             # 提交暂存区内容
memexia commit --amend                  # 修改最后一次提交

# 回退（类似Git Reset/Revert）
memexia rollback <COMMIT>               # 回退到某次提交
memexia rollback --hard                 # 硬回退（丢弃工作区）
memexia rollback --soft                 # 软回退（保留暂存区）
memexia revert <COMMIT>                 # 创建新提交回退（不改变历史）

# 推导链操作（暂存区操作）
memexia chain list                      # 列出暂存区推导链
memexia chain discard <CHAIN_ID>        # 丢弃推导链（不提交）
memexia chain commit <CHAIN_ID> -m "..." # 提交推导链到历史
```

> **设计说明**:
> - **历史**：类似Git，只记录**已提交**的变更，使用差异存储
> - **暂存区**：推导链、待提交的节点变更，类似于Git的staging area
> - **工作区**：当前编辑的文件、尚未暂存的变更

### 4.6 服务命令

> **设计说明**: 服务通过API暴露功能，AI服务通过外部LLM API接入（RAG向量化在本地）

```bash
# 启动HTTP API服务
memexia serve [--port <PORT>]              # 启动API服务器
memexia serve --daemon                     # 后台运行服务
memexia serve --host <IP>                  # 指定监听地址（默认localhost）

# 插件管理
memexia serve plugin list                  # 列出已安装的AI工作流插件
memexia serve plugin enable <PLUGIN>       # 启用插件
memexia serve plugin disable <PLUGIN>      # 禁用插件

# AI服务配置
memexia serve ai status                    # 查看AI服务连接状态
memexia serve ai test                      # 测试AI API连接
```

> **AI服务说明**:
> - AI功能通过API暴露（`POST /api/v1/ai/*`）
> - LLM调用外部API（OpenAI/Anthropic/Ollama）
> - 本地仅运行RAG向量化/索引组件
> - 工作流插件通过API注册和调用

### 4.7 配置命令

```bash
memexia config get <KEY>              # 获取配置
memexia config set <KEY> <VALUE>      # 设置配置
memexia config list                   # 列出所有配置
memexia config edit                   # 编辑配置文件
```

---

## 五、数据模型设计

### 5.1 核心原则：文件即节点

```rust
// 文件 <-> 节点 一一对应
struct FileNode {
    path: PathBuf,           // 文件路径
    node_id: Uuid,           // 对应的图节点ID
    content_hash: SHA256Hash, // 内容哈希
    created_at: DateTime<Utc>,
    updated_at: DateTime<Utc>,
}

// 添加文件时自动：
// 1. 创建节点
// 2. 解析带属性的链接 [[节点|关系类型]]
// 3. 根据关系类型创建边
// 4. 生成向量嵌入
// 5. 更新索引
```

### 5.2 链接语法设计

> **核心原则**: 链接必须带有关系类型，可以携带置信度和描述

#### 5.2.1 完整语法格式

```markdown
[[目标节点|关系类型:置信度:描述]]

或简化格式（使用默认值）：
[[目标节点|关系类型]]
```

#### 5.2.2 语法示例

```markdown
# 完整格式
[[决定论|矛盾:0.9:自由意志与决定论存在逻辑对立]]
[[实验证据|支持:0.85:神经科学实验支持某种观点]]

# 简化格式（使用默认值 1.0，无描述）
[[决定论|矛盾]]
[[意识|属于]]
```

| 参数 | 含义 | 默认值 | 范围 |
|-----|------|--------|------|
| `关系类型` | 边的类型 | 无默认值 | 必须指定 |
| `置信度` | 边的置信度 | 1.0 | 0.0 ~ 1.0 |
| `描述` | 对关系的解释说明 | 空字符串 | 任意文本 |

#### 5.2.3 Markdown示例

```markdown
# 自由意志

自由意志是...

## 与其他节点的关系

- [[决定论|矛盾:0.9:自由意志与决定论存在根本对立]] - 这是完整格式
- [[相容论|相关]] - 这是简化格式
- [[意识|属于:0.95:意识是心灵哲学的核心主题]]
- [[实验证据|支持:0.75:神经科学实验支持某种观点]]
- [[因果关系|推导]] - 因果关系可以推导出自由意志的可能性

## 链接语法

[[目标节点|关系类型:置信度:描述]]

其中：
- 关系类型必须是预定义的关系类型之一
- 置信度可选，默认为1.0
- 描述可选，用于解释为什么存在这个关系
```

### 5.3 节点类型（从文件元数据推断）

```rust
enum NodeType {
    Concept,      // 概念性文件
    Note,         // 普通笔记
    Journal,      // 日记/日志
    Draft,        // 草稿
    Reference,    // 引用/参考
    Summary,      // 摘要
    Question,     // 问题文件 (以 "?" 结尾或特定标签)
    Task,         // 任务文件 (以 "todo" 开头)
}

// 自动推断：系统根据文件名、内容推断类型
```

### 5.4 RDF图模型与关系类型

#### 5.4.1 预定义关系类型

```rust
// 边的关系类型 - 由用户在链接时明确指定
enum EdgeType {
    // 结构关系
    Contains,    // 包含：父节点包含子节点
    BelongsTo,   // 属于：子节点属于父节点 (Contains的反向)
    InstanceOf,  // 实例：某概念的具体实例

    // 因果/推导关系
    DerivesFrom, // 推导自：逻辑上从这个推导而来
    LeadsTo,     // 导向：逻辑上导致/引向
    Supports,    // 支持：提供证据支持某个观点
    Contradicts, // 矛盾：与某观点逻辑对立
    Refines,     // 精炼：对某观点的更精确表述

    // 语义关系
    RelatedTo,   // 相关：一般性关联
    SimilarTo,   // 相似：与某概念相似
    OppositeOf,  // 相反：与某概念相反
    PartOf,      // 部分：整体的一部分

    // 参考关系
    References,  // 引用：引用外部来源
    Cites,       // 引用：引用本文档

    // 元关系
    DependsOn,   // 依赖：依赖某概念
    EvolvesFrom, // 演化自：从某概念演化而来
    EvolvesInto, // 演化成：演化成某概念
}
```

#### 5.4.2 RDF图表示

```turtle
# 节点URI: urn:memexia:node:<uuid>
<urn:memexia:node:uuid-1>
    a memexia:Node ;
    memexia:filePath "notes/自由意志.md" ;
    memexia:contentHash "sha256:abc123..." ;
    memexia:type Concept ;
    memexia:createdAt "2025-01-01T00:00:00Z"^^xsd:dateTime ;
    memexia:updatedAt "2025-01-15T00:00:00Z"^^xsd:dateTime ;
    memexia:hasTag "哲学" , "心灵哲学" ;
    memexia:embedding [ ... ] .  # 向量嵌入

# 边URI: urn:memexia:edge:<uuid>
# 链接语法：[[目标节点|关系类型]]
<urn:memexia:edge:uuid-a>
    a memexia:Edge ;
    memexia:from <urn:memexia:node:uuid-1> ;
    memexia:to <urn:memexia:node:uuid-2> ;
    memexia:type "Contradicts" ;  # 关系类型（用户指定）
    memexia:strength 1.0 ;         # 用户指定的置信度
    memexia:source "explicit" ;    # 显式定义的链接
    memexia:description "自由意志与决定论是矛盾关系" .

# AI建议的链接（低置信度）
<urn:memexia:edge:uuid-b>
    a memexia:Edge ;
    memexia:from <urn:memexia:node:uuid-1> ;
    memexia:to <urn:memexia:node:uuid-3> ;
    memexia:type "RelatedTo" ;
    memexia:strength 0.75 ;
    memexia:confidence 0.72 ;      # AI置信度
    memexia:source "ai_suggested" ;
    memexia:description "AI基于语义相似性建议的连接" .
```

### 5.5 图历史与推导链追踪

> **核心设计**: Git式历史架构 - 工作目录 → 暂存区（推导链）→ 提交历史（差异存储）
>
> 关键概念：推导链相当于 Git 的暂存区（staging area），只有正式 `commit` 后才会被记录到历史。历史记录采用差异存储（delta），只保存变化部分，这样 history 才有意义。

#### 5.5.1 Git式三层架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Git式历史架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 工作目录 (Working Directory)                                        │   │
│  │  • 用户直接编辑的Markdown文件                                        │   │
│  │  • `memexia add` → 暂存文件                                         │   │
│  │  • 未暂存的内容不会进入历史                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 暂存区 (Staging Area / Derivation Chains)                           │   │
│  │                                                                      │   │
│  │  • AI生成的推导链存储于此                                             │   │
│  │  • `memexia chain list` → 查看暂存区推导链                          │   │
│  │  • `memexia chain discard <CHAIN_ID>` → 丢弃（不提交）              │   │
│  │  • `memexia commit -m "..."` → 提交到历史                           │   │
│  │                                                                      │   │
│  │  暂存区内容：                                                         │   │
│  │  • 待提交的节点变更                                                   │   │
│  │  • AI推导链（元数据、推理步骤）                                       │   │
│  │  • 新建的关系/链接                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 提交历史 (Committed History - 差异存储)                              │   │
│  │                                                                      │   │
│  │  • 只有 `commit` 后才会进入历史                                      │   │
│  │  • 差异存储：类似 Git，只记录变化部分                                 │   │
│  │  • 包含：节点变化、关系变化、推导链快照                               │   │
│  │                                                                      │   │
│  │  命令：                                                              │   │
│  │  `memexia history` → 查看历史                                       │   │
│  │  `memexia history --oneline` → 简洁格式                             │   │
│  │  `memexia rollback <COMMIT>` → 回退                                 │   │
│  │                                                                      │   │
│  │  存储：                                                              │   │
│  │  • Oxigraph: 图变化三元组                                            │   │
│  │  • Delta: 节点/关系的差异记录                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Layer 1: Git (文件层)                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 存储:                                                             │       │
│  │  • Blob: 文件内容快照                                             │       │
│  │  • Tree: 目录结构                                                │       │
│  │  • Commit: 提交记录（含图快照哈希）                                │       │
│  │                                                                   │       │
│  用途:                                                               │       │
│  • 跨仓库同步/克隆                                                    │       │
│  • 文件差异计算                                                      │       │
│  • 标签/里程碑标记                                                   │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                              │                                               │
│                              ▼                                               │
│  Layer 2: Oxigraph (图历史层 - 差异存储)                                    │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  存储:                                                               │       │
│  • 节点历史: 每个版本的节点内容（差异）                                 │       │
│  • 边历史: 关系的创建/删除历史                                         │       │
│  • 推导链: AI生成的推导路径（需commit才记录）                          │       │
│  • 快照: 图结构的完整哈希                                             │       │
│                                                                   │       │
│  用途:                                                               │       │
│  • 节点级别回退                                                      │       │
│  • AI推导链追踪                                                      │       │
│  • 可信度计算                                                        │       │
│  • 历史可视化                                                        │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 5.5.2 推导链追踪（暂存区概念）

```rust
// 推导链边 - 记录AI生成/推导的路径
enum DerivationEdge {
    GeneratedFrom,    // AI生成：节点A由节点B生成
    InferredFrom,     // AI推断：节点A由节点B推断而来
    SummarizedFrom,   // 摘要：由多个节点摘要而来
    ContradictedBy,   // 反证：被某证据反证
    SupportedBy,      // 支持：被某证据支持
}

// 推导链元数据
struct DerivationMetadata {
    chain_id: Uuid,           // 推导链ID
    step: u32,                // 推导步骤序号
    source_nodes: Vec<Uuid>,  // 来源节点
    target_node: Uuid,        // 目标节点
    confidence: f32,          // AI置信度
    model: String,            // 使用的模型
    prompt: String,           // 使用的提示词
    timestamp: DateTime<Utc>,
    parent_chain_id: Option<Uuid>,  // 父推导链（支持嵌套）
}

// 注意：推导链默认存储在暂存区，只有执行 `memexia commit` 后才会进入历史
// 暂存区操作命令（见 Section 4.5）：
//   - memexia chain list           # 列出暂存区推导链
//   - memexia chain discard <ID>   # 丢弃推导链（不进入历史）
//   - memexia chain commit <ID> -m "..."  # 提交推导链到历史
```

#### 5.5.3 差异存储（Delta Storage）

```rust
// 节点变化记录（类似 Git diff）
struct NodeDelta {
    node_id: Uuid,
    operation: DeltaOp,        // Create, Update, Delete
    field_changes: Vec<FieldDelta>,  // 字段级差异
    previous_version: Option<u32>,  // 上一版本号
    content_hash: String,      // 内容哈希
}

// 关系变化记录
struct EdgeDelta {
    edge_id: Uuid,
    from_node: Uuid,
    to_node: Uuid,
    edge_type: EdgeType,
    operation: DeltaOp,
    previous_confidence: Option<f32>,
}

// 存储优化：
//   - 全量快照：每隔 N 次提交存储一次完整快照
//   - 差异记录：中间版本只存储变化的部分
//   - 压缩存储：使用 RLE 或字典编码压缩重复模式
```

#### 5.5.4 历史查询示例

```sparql
-- 查询某个节点的推导链
PREFIX memexia: <http://memexia.org/schema/>

SELECT ?step ?source ?target ?model ?confidence
WHERE {
    ?edge memexia:type "GeneratedFrom" .
    ?edge memexia:from ?source .
    ?edge memexia:to ?target .
    ?edge memexia:chainId "uuid-chain-1" .
    ?edge memexia:step ?step .
    OPTIONAL { ?edge memexia:model ?model }
    OPTIONAL { ?edge memexia:confidence ?confidence }
}
ORDER BY ?step

-- 检测循环推导（AI谬误检测）
SELECT ?node WHERE {
    ?a memexia:from ?node .
    ?a memexia:type "GeneratedFrom" .
    ?a memexia:chainId ?chain .
    ?b memexia:from ?a .
    ?b memexia:to ?node .
    ?b memexia:type "GeneratedFrom" .
}
```

#### 5.5.4 回退机制（Git式）

> 回退机制类似 Git，支持软回退、硬回退和 revert（不改变历史）

```bash
# 查看历史（见 Section 4.5）
memexia history                         # 查看当前历史
memexia history --oneline               # 简洁格式
memexia history --graph                 # 图形化展示
memexia history <COMMIT>                # 查看某次提交详情
memexia history <FILE>                  # 查看文件的变更历史

# 回退（类似Git Reset - 改变历史）
memexia rollback <COMMIT>               # 软回退（保留暂存区，默认）
memexia rollback <COMMIT> --hard        # 硬回退（丢弃工作区所有变更）
memexia rollback <COMMIT> --soft        # 软回退（保留暂存区和变更）
memexia rollback --reset                # 重置暂存区（不修改工作区）

# Revert（类似Git Revert - 不改变历史）
memexia revert <COMMIT>                 # 创建新提交回退（安全）
memexia revert <COMMIT> --no-edit       # 不编辑提交信息

# 回退单个节点
memexia rollback node <NODE_ID>         # 回退到最新版本
memexia rollback node <NODE_ID> --to <COMMIT>

# 暂存区推导链操作（见 Section 4.5）
memexia chain list                      # 列出暂存区推导链
memexia chain discard <CHAIN_ID>        # 丢弃推导链（不提交）
memexia chain commit <CHAIN_ID> -m "..." # 提交推导链到历史
```

#### 5.5.5 AI可信度计算

```
可信度 = f(推导链长度, 源头可信度, 模型置信度, 反证数量)

公式:
credibility(node) =
    base_credibility *
    (0.9 ^ chain_length) *  # 推导链越长，可信度衰减
    product(source_credibility) *  # 源头节点可信度
    model_weight *  # 模型权重
    (1 - contradiction_ratio)  # 反证比例

高可信度节点: 源头节点、AI高置信度、零反证
低可信度节点: 长推导链、低模型置信度、多反证
```

### 5.6 三层架构落地实现

> **核心设计**: 可控AI思考脚手架 - 让AI思考可检查、可修正、可控制

#### 5.6.1 三层架构详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           三层架构                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 控制层（Control Layer）                                              │   │
│  │                                                                      │   │
│  │  职责：                                                              │   │
│  │  • 定义什么问题该解决                                                 │   │
│  │  • 确保解决方案符合价值观                                             │   │
│  │  • 随时检查、修正、指导                                               │   │
│  │                                                                      │   │
│  │  命令：                                                              │   │
│  │  memexia ai constraint add "价值观约束..."  # 添加价值观约束         │   │
│  │  memexia ai approve <NODE_ID>                # 批准节点             │   │
│  │  memexia ai reject <NODE_ID> --reason "..."  # 拒绝节点             │   │
│  │  memexia ai guide "请从相容论角度思考..."     # 指导AI方向           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    ▲                                        │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 结构思考层（Structured Thinking Layer）                              │   │
│  │                                                                      │   │
│  │  职责：                                                              │   │
│  │  • 突破LLM上下文限制（存储中间推导结果）                               │   │
│  │  • 透明可追溯的推理路径                                               │   │
│  │  • 可信度计算与回退机制                                               │   │
│  │                                                                      │   │
│  │  存储：                                                              │   │
│  │  • Oxigraph 图数据库（存储推导链）                                    │   │
│  │  • 向量索引（存储语义相似度）                                         │   │
│  │  • 推导链YAML（存储中间步骤）                                         │   │
│  │                                                                      │   │
│  │  命令：                                                              │   │
│  │  memexia chain find <NODE_ID>           # 查找推导链                 │   │
│  │  memexia chain verify <NODE_ID>         # 验证可信度                 │   │
│  │  memexia chain trace <NODE_ID>          # 追溯推理路径               │   │
│  │  memexia rollback chain <CHAIN_ID>      # 回退推导链                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    ▲                                        │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 即时思考层（Immediate Thinking Layer）                               │   │
│  │                                                                      │   │
│  │  职责：                                                              │   │
│  │  • 快速响应用户请求                                                   │   │
│  │  • 轻量级推理（不涉及复杂推导链）                                      │   │
│  │  • 从结构思考层获取上下文                                             │   │
│  │                                                                      │   │
│  │  场景：                                                              │   │
│  │  • 简单问答（不需要中间推导）                                          │   │
│  │  • 快速摘要                                                          │   │
│  │  • 即时建议                                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  价值：可信任的AI协作，而非黑盒AI                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 5.6.2 控制层命令

```bash
# 价值观约束
memexia ai constraint add "避免过于乐观的结论"  # 添加约束
memexia ai constraint list                       # 列出约束
memexia ai constraint remove <ID>                # 移除约束

# 节点审批
memexia ai approve <NODE_ID>                     # 批准AI生成的节点
memexia ai reject <NODE_ID> --reason "不符合逻辑"  # 拒绝
memexia ai pending                               # 查看待审批列表

# AI指导
memexia ai guide "请从相容论视角分析自由意志"     # 设置思考方向
memexia ai guide clear                           # 清除指导

# 审查模式
memexia ai review <NODE_ID>                      # 审查节点推导链
memexia ai review --all                          # 审查所有AI生成节点
```

#### 5.6.3 结构思考层命令

```bash
# 推导链操作
memexia chain show <CHAIN_ID>           # 显示推导链详情
memexia chain find <NODE_ID>            # 查找某节点的推导链
memexia chain trace <NODE_ID>           # 追溯推理路径（可视化）
memexia chain verify <NODE_ID>          # 验证可信度
memexia chain stats                     # 推导链统计

# 可信度查看
memexia credibility <NODE_ID>           # 查看节点可信度
memexia credibility --low               # 查看低可信度节点

# 回退操作
memexia rollback chain <CHAIN_ID>       # 回退整个推导链
memexia rollback chain <CHAIN_ID> --step 3  # 回退到第几步
```

#### 5.6.4 即时思考层命令

```bash
# 快速问答（不生成推导链）
memexia ask "自由意志是什么？"           # 简单问答
memexia ask --quick "相容论的核心观点"   # 快速摘要

# 即时建议
memexia suggest <FILE>                  # 基于当前节点建议链接
memexia suggest --ai <FILE>             # AI建议（可能生成推导链）
```

---

### 6.1 RAG 检索增强生成

```
┌─────────────────────────────────────────────────────────────────┐
│                        RAG 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户提问                                                         │
│      │                                                           │
│      ▼                                                           │
│  ┌─────────────┐                                                 │
│  │ 1. 向量化   │  将问题转换为向量                                │
│  │   问题      │                                                 │
│  └──────┬──────┘                                                 │
│         │                                                         │
│         ▼                                                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐        │
│  │ 2. 语义搜索 │ ──> │ 3. 图遍历   │ ──> │4. 上下文    │        │
│  │   检索相关  │     │   扩展关联  │     │   组合      │        │
│  │   节点      │     │   节点      │     │             │        │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘        │
│         │                   │                   │                 │
│         └───────────────────┼───────────────────┘                 │
│                             ▼                                     │
│                    ┌──────────────┐                               │
│                    │ 5. LLM生成   │  基于图谱上下文回答            │
│                    │   回答       │                               │
│                    └──────────────┘                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

API:
POST /api/v1/ai/ask
{
  "question": "自由意志和决定论有什么关系？",
  "context_files": ["notes/philosophy/*.md"],  // 可选，限制范围
  "max_context_nodes": 10,
  "include_subgraph": true
}

Response:
{
  "answer": "根据图谱分析，自由意志和决定论之间存在...",
  "sources": ["uuid-1", "uuid-2"],
  "reasoning_path": ["uuid-1" -> "edge-1" -> "uuid-2"]
}
```

### 6.2 自动链接发现

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI链接发现流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  触发方式:                                                        │
│  • 文件提交时自动分析                                              │
│  • 手动调用 memexia ai link suggest                               │
│  • 定时批量分析                                                   │
│                                                                 │
│  分析步骤:                                                        │
│  1. 读取文件内容                                                   │
│  2. 提取关键概念（NER、关键词提取）                                 │
│  3. 计算与现有节点的语义相似度                                      │
│  4. 分析论证结构（前提→结论、支持→反对）                             │
│  5. 生成链接建议（带置信度）                                        │
│                                                                 │
│  输出:                                                           │
│  {                                                              │
│    "file": "notes/new_thought.md",                              │
│    "suggestions": [                                              │
│      {                                                          │
│        "target": "uuid-existing-node",                           │
│        "reason": "两文都讨论了意识的主观性",                        │
│        "edge_type": "RELATED_TO",                                │
│        "confidence": 0.85                                        │
│      }                                                          │
│    ]                                                             │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

命令:
memexia ai link auto          # 自动创建置信度>0.9的链接
memexia ai link suggest       # 显示建议但不自动创建
memexia ai link review        # 交互式审查所有建议
```

### 6.3 节点自动生成

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI节点生成流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入:                                                           │
│  • 源文件（种子节点）                                              │
│  • 生成数量                                                      │
│  • 生成方向（探索/延伸/反证/具体化）                                │
│                                                                 │
│  生成策略:                                                        │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 探索方向 (Explore)                                         │  │
│  │ • "基于这个概念，可能有哪些相关方向？"                       │  │
│  │ • 产出：发散性的新节点                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 延伸方向 (Extend)                                          │  │
│  │ • "这个概念的逻辑后果是什么？"                               │  │
│  │ • 产出：演绎性的新节点                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 反证方向 (Counter)                                         │  │
│  │ • "这个观点可能的反驳是什么？"                               │  │
│  │ • 产出：对立/补充视角的新节点                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 具体方向 (Concretize)                                      │  │
│  │ • "这个概念有什么具体例子？"                                 │  │
│  │ • 产出：实例化的新节点                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

命令:
memexia ai generate notes/free_will.md                    # 基于文件生成
memexia ai generate --count 5 --direction explore notes/free_will.md
memexia ai expand "自由意志"                              # 展开主题
```

### 6.4 AI工作流引擎

> **核心设计**: 自动化思考探索，支持多种工作流模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI工作流引擎                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  工作流类型:                                                      │
│                                                                 │
│  1. 探索性工作流 (exploration)                                    │
│     • 从任意节点开始                                               │
│     • 自动发现相关节点                                             │
│     • 生成探索报告                                                 │
│     • 命令: memexia ai workflow start exploration --from <FILE>  │
│                                                                 │
│  2. 论证分析工作流 (argument-analysis)                            │
│     • 分析节点的论证结构                                           │
│     • 识别前提、结论、支持、反驳                                    │
│     • 生成分析报告                                                 │
│     • 命令: memexia ai workflow start argument-analysis <FILE>   │
│                                                                 │
│  3. 知识补全工作流 (knowledge-completion)                         │
│     • 识别图谱中的空白                                              │
│     • 生成待探索方向                                               │
│     • 建议可能的链接                                               │
│     • 命令: memexia ai workflow start knowledge-completion       │
│                                                                 │
│  4. 推导性工作流 (derivation)                                      │
│     • 严格推导：A → B → C → ...                                   │
│     • 记录每一步的逻辑依据                                         │
│     • 检测推导中的逻辑漏洞                                         │
│     • 命令: memexia ai workflow start derivation --from <FILE>   │
│                                                                 │
│  5. 综合工作流 (synthesis)                                         │
│     • 综合多个节点形成新观点                                       │
│     • 分析各方观点的优缺点                                         │
│     • 生成综合报告                                                 │
│     • 命令: memexia ai workflow start synthesis --nodes <ID1,ID2>│
│                                                                 │
│  6. 批判工作流 (critique)                                          │
│     • 对某观点进行批判分析                                         │
│     • 寻找反例和漏洞                                               │
│     • 生成批判报告                                                 │
│     • 命令: memexia ai workflow start critique --target <FILE>   │
│                                                                 │
│  7. 定期回顾工作流 (review)                                        │
│     • 分析近期修改的节点                                           │
│     • 发现潜在的连接                                               │
│     • 生成更新建议                                                 │
│     • 命令: memexia ai workflow start review --days 7            │
│                                                                 │
│  工作流配置示例:                                                   │
│  {                                                              │
│    "name": "weekly-exploration",                               │
│    "type": "exploration",                                      │
│    "trigger": "cron(0 9 * * 1)",  // 每周一9点                    │
│    "steps": [                                                  │
│      {"action": "discover", "from": "recent_nodes"},           │
│      {"action": "generate", "count": 3},                       │
│      {"action": "report", "format": "markdown"}                │
│    ],                                                          │
│    "constraints": [                                            │
│      "避免过于乐观的结论",                                        │
│      "优先使用已有节点"                                           │
│    ]                                                           │
│  }                                                              │
│                                                                 │
│  工作流命令:                                                      │
│  memexia ai workflow start <TYPE> --from <FILE>   # 启动工作流   │
│  memexia ai workflow list                             # 列出工作流│
│  memexia ai workflow logs <ID>                        # 查看日志  │
│  memexia ai workflow stop <ID>                        # 停止工作流│
│  memexia ai workflow export <ID> --format json       # 导出结果  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.4.1 工作流状态机

```
┌─────────────────────────────────────────────────────────────────┐
│                    工作流状态转换                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   pending ──→ running ──→ completed                            │
│      │            │            │                                │
│      │            │            ├─→ approved                     │
│      │            │            │                                │
│      │            │            └─→ rejected                     │
│      │            │                                             │
│      │            └─→ paused                                    │
│      │                      │                                  │
│      └──────────────────────┘                                  │
│                                                                 │
│  状态说明:                                                        │
│  • pending:   等待启动                                           │
│  • running:   执行中                                            │
│  • paused:    暂停（等待用户输入）                                │
│  • completed: 完成（等待审批）                                     │
│  • approved:  已批准（合并到主图谱）                               │
│  • rejected:  已拒绝（不合并）                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、仓库数据结构与同步协议

### 7.1 仓库目录结构

> **设计理念**: 利用 Git，不重复造轮子。直接使用 `.git/` 存储文件，图数据使用专用格式。

```
memexia-repository/
├── 📁 .git/                       # Git存储（文件版本控制）
│   ├── HEAD
│   ├── config
│   ├── objects/                   # Blob/Tree/Commit 对象
│   └── refs/
│
├── 📁 .memexia/                   # Memexia 专用数据
│   ├── 📄 meta.json               # 仓库元数据（必须存在）
│   ├── 📄 graph.nq                # 主图数据（N-Quads格式）
│   ├── 📄 graph.nq.gz             # 压缩的图快照
│   │
│   ├── 📁 derivations/            # AI推导链数据
│   │   ├── chain_001.yaml
│   │   ├── chain_002.yaml
│   │   └── ...
│   │
│   ├── 📁 history/                # 图历史
│   │   ├── commits/               # 提交快照（JSON）
│   │   │   ├── commit_001.json
│   │   │   └── ...
│   │   └── snapshots/             # 图谱快照
│   │       ├── snapshot_001.nq.gz
│   │       └── ...
│   │
│   ├── 📁 indexes/                # 各种索引
│   │   ├── title.idx              # 标题索引
│   │   ├── tag.idx                # 标签索引
│   │   ├── vector.idx             # 向量索引（可选）
│   │   └── derivation.idx         # 推导链索引
│   │
│   └── 📁 sync/                   # 同步状态
│       ├── remote.json            # 远程配置
│       ├── last_sync.json         # 最后同步状态
│       └── temp/                  # 临时同步文件
│
├── 📄 memexia.json                # 仓库配置
└── 📁 notes/                      # 用户文件（节点）
    ├── 自由意志.md
    ├── 决定论.md
    └── ...
```

**设计说明**:
- **`.git/`**: 复用 Git 存储原始文件，享受成熟的版本控制
- **`.memexia/graph.nq`**: Memexia 专用的图数据，与 Git 分离
- **`.memexia/derivations/`**: AI推导链，Memexia 专用
- **分离原则**: Git 管文件，Memexia 管图语义

### 7.2 仓库元数据格式 (meta.json)

```json
{
  "version": "1.0.0",
  "format": "memexia-repo",
  "created_at": "2025-12-31T00:00:00Z",
  "updated_at": "2025-12-31T12:00:00Z",
  "repository": {
    "id": "uuid-v4",
    "name": "我的知识库",
    "description": "个人知识图谱",
    "owner": "user-id"
  },
  "stats": {
    "node_count": 156,
    "edge_count": 423,
    "file_count": 89,
    "ai_derived_count": 34
  },
  "compatibility": {
    "min_version": "1.0.0",
    "features": ["graph", "derivations", "ai"]
  }
}
```

### 7.3 图数据序列化格式

#### 7.3.1 N-Quads主图格式 (graph.nq)

Memexia 使用 W3C N-Quads 格式存储图数据，扩展支持推导链元数据：

```nq
# 基础节点
<urn:memexia:file:notes/自由意志.md> <http://purl.org/dc/elements/1.1/title> "自由意志" .
<urn:memexia:file:notes/自由意志.md> <http://memexia.org/schema/type> "Concept" .
<urn:memexia:file:notes/自由意志.md> <http://memexia.org/schema/tags> "哲学" .

# 带类型的链接
<urn:memexia:file:notes/自由意志.md> <http://memexia.org/schema/linksTo> <urn:memexia:file:notes/决定论.md> <urn:memexia:file:metadata/edge/001> .
<urn:memexia:file:notes/决定论.md> <http://memexia.org/schema/linksTo> <urn:memexia:file:notes/自由意志.md> <urn:memexia:file:metadata/edge/001> .

# 边元数据 (blank node)
<urn:memexia:file:metadata/edge/001> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://memexia.org/schema/Edge> .
<urn:memexia:file:metadata/edge/001> <http://memexia.org/schema/relationType> "contradicts" .
<urn:memexia:file:metadata/edge/001> <http://memexia.org/schema/createdBy> "user" .
<urn:memexia:file:metadata/edge/001> <http://memexia.org/schema/createdAt> "2025-12-31T10:00:00Z" .

# AI推导链关联
<urn:memexia:file:notes/AI生成的结论.md> <http://memexia.org/schema/derivedFrom> <urn:memexia:file:chain/uuid-001> .
<urn:memexia:file:chain/uuid-001> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://memexia.org/schema/DerivationChain> .
<urn:memexia:file:chain/uuid-001> <http://memexia.org/schema/chainId> "uuid-001" .
<urn:memexia:file:chain/uuid-001> <http://memexia.org/schema/model> "gpt-4" .
```

#### 7.3.2 推导链格式 (YAML)

```yaml
# derivations/chain_uuid-001.yaml
chain_id: "uuid-001"
type: "inference"  # inference | generation | summarization | exploration
model: "gpt-4"
prompt: "基于以下节点，推断它们之间的关系..."
confidence: 0.87
created_at: "2025-12-31T10:00:00Z"
parent_chain_id: null  # 支持嵌套推导链

steps:
  - step: 1
    source_nodes:
      - "urn:memexia:file:notes/自由意志.md"
      - "urn:memexia:file:notes/决定论.md"
    operation: "analyze_contradiction"
    result: "发现两概念存在逻辑矛盾"
    confidence: 0.92

  - step: 2
    source_nodes:
      - "urn:memexia:file:notes/自由意志.md"
      - "urn:memexia:file:notes/决定论.md"
    operation: "generate_synthesis"
    result: "提出兼容两者的第三种理解框架"
    confidence: 0.85

generated_nodes:
  - node_id: "urn:memexia:file:notes/兼容论.md"
    content_hash: "sha256-abc123..."
    created_at: "2025-12-31T10:05:00Z"

suggested_edges:
  - source: "urn:memexia:file:notes/自由意志.md"
    target: "urn:memexia:file:notes/兼容论.md"
    type: "supports"
    confidence: 0.88
    auto_accepted: false
```

### 7.4 同步协议设计

#### 7.4.1 同步消息格式 (MessagePack)

```
┌─────────────────────────────────────────────────────────────────────┐
│                       同步协议消息格式                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  Push/Fetch 请求:                                                    │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐          │
│  │ magic(4) │ version  │  type    │  flags   │ length   │          │
│  │ 0x4D58   │ 1 byte   │ 1 byte   │ 1 byte   │ 4 bytes  │          │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘          │
│  │                        payload (JSON/MessagePack)               │
│  └─────────────────────────────────────────────────────────────────┘
│                                                                       │
│  消息类型 (type):                                                    │
│  ├── 0x01: Hello          # 连接握手                                 │
│  ├── 0x02: FetchRequest   # 拉取请求                                 │
│  ├── 0x03: FetchResponse  # 拉取响应                                 │
│  ├── 0x04: PushRequest    # 推送请求                                 │
│  ├── 0x05: PushResponse   # 推送响应                                 │
│  ├── 0x06: SyncDiff       # 差异同步                                 │
│  ├── 0x07: ConflictNotify # 冲突通知                                 │
│  └── 0x08: SyncComplete   # 同步完成                                 │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

#### 7.4.2 拉取请求 (FetchRequest)

```json
{
  "request_id": "uuid-v4",
  "client_version": "1.0.0",
  "last_sync": "2025-12-30T12:00:00Z",
  "want": {
    "graph": true,
    "derivations": true,
    "objects": true,
    "since": "2025-12-30T12:00:00Z"
  },
  "have": {
    "graph_hash": "sha256-abc123def456...",
    "node_count": 156,
    "edge_count": 423
  }
}
```

#### 7.4.3 推送请求 (PushRequest)

```json
{
  "request_id": "uuid-v4",
  "client_version": "1.0.0",
  "commits": [
    {
      "commit_id": "uuid-v4",
      "message": "添加自由意志与决定论的关系分析",
      "author": "user-id",
      "timestamp": "2025-12-31T10:00:00Z",
      "changes": {
        "added_nodes": ["urn:memexia:file:notes/兼容论.md"],
        "added_edges": [
          {
            "source": "urn:memexia:file:notes/自由意志.md",
            "target": "urn:memexia:file:notes/兼容论.md",
            "type": "supports"
          }
        ],
        "added_derivations": ["uuid-001"],
        "modified_files": ["notes/自由意志.md", "notes/决定论.md"]
      }
    }
  ],
  "graph_delta": {
    "added_triples": [...],
    "removed_triples": [...]
  },
  "derivation_updates": [
    {
      "chain_id": "uuid-001",
      "type": "create",
      "data": {...}
    }
  ]
}
```

### 7.5 冲突检测与解决

> **核心设计**: 逻辑冲突处理，而非简单的合并冲突。AI辅助分析冲突原因。

#### 7.5.1 冲突类型与处理策略

| 冲突类型 | 描述 | 解决策略 |
|---------|------|---------|
| **节点冲突** | 同一文件被双方修改 | 3-way merge（内容合并） |
| **边冲突** | 同一对节点间存在冲突的边类型 | AI分析关系合理性，建议保留/删除/修改 |
| **逻辑矛盾** | 产生逻辑循环或矛盾 | 推导链回溯，标记为"待审视" |
| **版本分歧** | AI推导链指向不同的父节点 | 保留多个版本，展示分歧点 |

#### 7.5.2 冲突处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    冲突处理流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  检测到冲突                                                      │
│       │                                                         │
│       ├─→ 节点冲突 ──→ 3-way merge ──→ 自动合并/手动解决        │
│       │                                                         │
│       ├─→ 边冲突 ──→ AI分析 ──→ 建议方案 ──→ 用户确认           │
│       │                  │                                      │
│       │                  ├── 保留A                              │
│       │                  ├── 保留B                              │
│       │                  ├── 保留两者（标记为分歧）              │
│       │                  └── 修改为新关系                       │
│       │                                                         │
│       └─→ 逻辑矛盾 ──→ 推导链回溯 ──→ 标记"待审视"              │
│                          │                                      │
│                          ├── 移除矛盾边                         │
│                          └── 创建反证节点                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 7.5.3 AI冲突分析示例

```json
{
  "conflict_id": "uuid-v4",
  "detected_at": "2025-12-31T12:00:00Z",
  "type": "edge_conflict",
  "resource": {
    "type": "edge",
    "source": "urn:memexia:file:notes/自由意志.md",
    "target": "urn:memexia:file:notes/决定论.md"
  },
  "conflicting_edges": [
    {
      "user": "user-a",
      "edge_type": "contradicts",
      "confidence": 0.9,
      "description": "自由意志与决定论存在根本对立"
    },
    {
      "user": "user-b",
      "edge_type": "supports",
      "confidence": 0.75,
      "description": "决定论支持某种自由意志解释"
    }
  ],
  "ai_analysis": {
    "summary": "两个用户对自由意志与决定论的关系有不同理解",
    "possible_interpretations": [
      "user-a 认为两者完全对立（经典矛盾观）",
      "user-b 可能在讨论相容论视角下的关系"
    ],
    "suggested_resolution": {
      "action": "create_bridge_node",
      "description": "创建'相容论'节点，整合两种观点",
      "new_edges": [
        {"from": "自由意志", "to": "相容论", "type": "related"},
        {"from": "决定论", "to": "相容论", "type": "related"},
        {"from": "自由意志", "to": "相容论", "type": "contradicts"},
        {"from": "决定论", "to": "相容论", "type": "contradicts"}
      ]
    }
  },
  "resolution": "pending",
  "resolved_by": null
}
```

#### 7.5.4 自动合并算法

```
合并优先级:
1. 用户明确接受的AI建议 > 用户手动创建
2. 时间戳更近的修改 > 旧的修改
3. 置信度更高的AI推导 > 低置信度
4. 如果无法自动解决，降级为手动冲突

逻辑矛盾处理:
- 检测到循环推导 → 标记为"待审视"，暂停自动合并
- 检测到反证关系 → 创建反证节点，建立反证边
```

### 7.6 同步命令

```bash
# 仓库初始化与远程配置
memexia init                          # 初始化本地仓库
memexia remote add <NAME> <URL>       # 添加远程仓库
memexia remote list                   # 列出远程仓库
memexia remote remove <NAME>          # 移除远程仓库

# 同步操作
memexia sync                          # 完整同步（fetch + merge + push）
memexia fetch                         # 仅拉取远程变更
memexia push                          # 仅推送本地变更
memexia pull                          # 拉取并合并（等同于 sync --no-push）

# 状态与历史
memexia sync status                   # 显示同步状态
memexia sync log                      # 显示同步历史
memexia sync resolve <CONFLICT_ID>    # 解决冲突

# 远程协作（类GitHub但不依赖GitHub）
memexia fork <REMOTE_URL>             # Fork远程仓库到本地
memexia fork list                     # 列出本地Forks
memexia merge-request create          # 创建合并请求
memexia mr list                       # 列出合并请求
memexia mr review <MR_ID>             # 审查合并请求
memexia mr accept <MR_ID>             # 接受合并请求

# 讨论与评论
memexia comment add <FILE> --body "<TEXT>"    # 添加评论
memexia comment list <FILE>                   # 列出评论
memexia mention list                          # 提及通知

# 访问控制
memexia access add <USER> --read|write|admin  # 添加协作者
memexia access remove <USER>                   # 移除协作者
```

### 7.7 远程服务器API

| 方法 | 路径 | 功能 |
|------|------|------|
| **仓库** |||
| POST | `/api/v1/repos` | 创建仓库 |
| GET | `/api/v1/repos/{id}` | 获取仓库信息 |
| **同步** |||
| POST | `/api/v1/repos/{id}/sync/fetch` | 拉取变更 |
| POST | `/api/v1/repos/{id}/sync/push` | 推送变更 |
| GET | `/api/v1/repos/{id}/sync/status` | 获取同步状态 |
| **合并请求** |||
| POST | `/api/v1/repos/{id}/mr` | 创建MR |
| GET | `/api/v1/repos/{id}/mr` | 列出MR |
| POST | `/api/v1/repos/{id}/mr/{mr_id}/accept` | 接受MR |

---

## 八、图谱CLI展示

### 8.1 JSON结构输出（推荐）

```bash
$ memexia graph show --json
```

```json
{
  "meta": {
    "node_count": 47,
    "edge_count": 89,
    "last_updated": "2025-01-15T10:30:00Z"
  },
  "nodes": [
    {
      "id": "a1b2c3d4",
      "file_path": "notes/自由意志.md",
      "type": "Concept",
      "tags": ["哲学", "心灵哲学"],
      "importance": 0.92,
      "degree": {
        "in": 8,
        "out": 5
      }
    }
  ],
  "edges": [
    {
      "id": "e1f2g3h4",
      "source": "a1b2c3d4",
      "target": "i5j6k7l8",
      "type": "SUPPORTS",
      "strength": 0.85,
      "source_type": "explicit|ai_suggested"
    }
  ]
}
```

### 8.2 图谱统计信息

```bash
$ memexia graph stats

═══════════════════════════════════════════════
           Memexia 图谱统计报告
═══════════════════════════════════════════════

📊 基础统计
├── 节点总数: 47
├── 边总数: 89
│   ├── 显式链接: 65 (73%)
│   └── AI建议: 24 (27%)
├── 平均度: 3.79
└── 图密度: 0.082

📈 文件类型分布
├── 概念 (Concept): 18 (38.3%)
├── 笔记 (Note): 15 (31.9%)
├── 问题 (Question): 8 (17.0%)
└── ...

🎯 AI活跃度
├── 自动生成节点: 12
├── 建议链接: 24 (已采纳: 18)
└── RAG查询次数: 156

═══════════════════════════════════════════════
```

---

## 九、API接口设计

### 9.1 RESTful API

| 方法 | 路径 | 功能 |
|------|------|------|
| **仓库** |||
| POST | `/api/v1/repos` | 创建仓库 |
| GET | `/api/v1/repos/{owner}/{name}` | 获取仓库信息 |
| DELETE | `/api/v1/repos/{owner}/{name}` | 删除仓库 |
| **文件/节点** |||
| GET | `/api/v1/repos/{owner}/{name}/files` | 列出文件 |
| GET | `/api/v1/repos/{owner}/{name}/files/{path}` | 获取文件/节点 |
| **图查询** |||
| GET | `/api/v1/repos/{owner}/{name}/graph` | 获取图结构 |
| POST | `/api/v1/repos/{owner}/{name}/graph/query` | SPARQL查询 |
| **AI** |||
| POST | `/api/v1/repos/{owner}/{name}/ai/ask` | RAG问答 |
| POST | `/api/v1/repos/{owner}/{name}/ai/link/suggest` | 链接建议 |
| POST | `/api/v1/repos/{owner}/{name}/ai/generate` | 节点生成 |
| POST | `/api/v1/repos/{owner}/{name}/ai/workflow/start` | 启动工作流 |
| **版本控制** |||
| GET | `/api/v1/repos/{owner}/{name}/commits` | 列出提交 |
| **历史与回退** |||
| GET | `/api/v1/repos/{owner}/{name}/history` | 查看图历史 |
| GET | `/api/v1/repos/{owner}/{name}/history/{nodeId}` | 查看节点历史 |
| GET | `/api/v1/repos/{owner}/{name}/chains` | 列出推导链 |
| GET | `/api/v1/repos/{owner}/{name}/chains/{chainId}` | 获取推导链详情 |
| POST | `/api/v1/repos/{owner}/{name}/rollback` | 回退操作 |
| **同步** |||
| POST | `/api/v1/repos/{owner}/{name}/sync/push` | 推送 |
| POST | `/api/v1/repos/{owner}/{name}/sync/pull` | 拉取 |
| GET | `/api/v1/repos/{owner}/{name}/sync/status` | 同步状态 |

### 9.2 AI问答API示例

```json
// POST /api/v1/repos/{owner}/{name}/ai/ask
// Request
{
  "question": "自由意志和决定论有什么关系？在图谱中找相关的论证",
  "context_files": ["notes/philosophy/*.md"],
  "max_context_nodes": 10,
  "include_subgraph": true,
  "model": "gpt-4"
}

// Response
{
  "answer": "根据图谱分析，自由意志和决定论之间存在以下关系：\n\n1. **矛盾关系**：自由意志主张...，决定论认为...\n\n2. **支持证据**：\n   - 节点A支持自由意志\n   - 节点B支持决定论\n\n3. **图谱路径**：自由意志 --SUPPORTS--> 论证1 <--SUPPORTS-- 决定论",
  "sources": ["uuid-1", "uuid-2", "uuid-3"],
  "reasoning_path": {
    "nodes": ["uuid-1", "uuid-2", "uuid-3"],
    "edges": ["e1", "e2"]
  },
  "model_used": "gpt-4",
  "tokens_used": 1234
}
```

---

## 十、实现路线图

### Phase 1: 核心引擎 (第1-3月)

#### Month 1: 基础架构 + 文件即节点

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W1-2 | 完善存储层抽象 | storage/mod.rs, oxigraph.rs, sqlite.rs |
| W3-4 | 文件监听与自动图更新 | watcher.rs, indexer.rs |
| W1-4 | Markdown解析增强 | parser.rs (双向链接[[]]提取) |

#### Month 2: 版本控制与图历史

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W5-6 | Git集成 | git.rs (文件存储、差异计算) |
| W7-8 | 图历史系统 | graph_history.rs (节点快照、推导链) |
| W7-8 | 回退机制 | rollback.rs (节点/推导链回退) |

#### Month 3: CLI基础

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W9-10 | 基础命令实现 | init, add, commit, status, log |
| W11-12 | 图谱命令实现 | graph show, graph query |

### Phase 2: AI核心 (第4-6月) - **最重要阶段**

#### Month 4: 向量嵌入与RAG基础

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W13-14 | 向量嵌入生成 | embeddings.rs |
| W15-16 | RAG基础实现 | rag.rs (语义搜索 + 上下文组合) |

#### Month 5: 自动链接发现

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W17-18 | 语义相似度计算 | linker.rs 核心逻辑 |
| W19-20 | 链接建议生成 | AI推荐算法 + 置信度计算 |

#### Month 6: 节点生成与工作流

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W21-22 | 节点自动生成 | generator.rs |
| W23-24 | AI工作流引擎 | workflow.rs |

### Phase 3: API与服务 (第7-9月)

#### Month 7: HTTP API + AI服务

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W25-26 | API框架搭建 | api/mod.rs, routes/ |
| W27-28 | 核心API实现 | graph, commits, AI endpoints |

#### Month 8: 实时通信与同步

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W29-30 | WebSocket | websocket.rs |
| W31-32 | 同步协议 | push.rs, fetch.rs, remote.rs |

#### Month 9: 服务与认证

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W33-34 | CLI服务命令 | serve命令, AI服务独立运行 |
| W35-36 | 认证与授权 | auth.rs, 性能优化 |

### Phase 4: 完善与发布 (第10-12月)

#### Month 10-11: 协作功能

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W37-38 | Fork/图路径PR | fork.rs, pull_request.rs |
| W39-40 | 评论与通知 | comment.rs, notification.rs |

#### Month 12: 测试与发布

| 周次 | 任务 | 交付物 |
|------|------|--------|
| W43-44 | 完善文档 | API文档、CLI文档 |
| W45-48 | 测试与发布 | 完整测试套件, v1.0.0发布 |

---

## 十一、技术栈详情

### 11.1 核心依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| oxigraph | 0.5+ | RDF图数据库 |
| sqlite | 0.35+ | 元数据存储 |
| tokio | 1.35+ | 异步运行时 |
| warp/axum | latest | HTTP服务器 |
| clap | 4.4+ | CLI框架 |
| sha2 | 0.10+ | 内容哈希 |
| chrono | 0.4+ | 时间处理 |
| serde | 1.0+ | 序列化 |

### 11.2 AI相关依赖

| 依赖 | 用途 | 集成时机 |
|------|------|---------|
| openai-rs | OpenAI API | Phase 2 |
| ollama-rs | Ollama本地模型 | Phase 2 |
| embeddings | 向量生成 | Phase 2 |
| faiss/chroma | 向量存储 | Phase 2 |

---

## 十二、文件结构

```
memexia/
├── Cargo.toml
├── src/
│   ├── main.rs              # CLI入口
│   ├── lib.rs               # 库入口
│   │
│   ├── core/                # 核心业务逻辑
│   │   ├── mod.rs
│   │   ├── repository.rs    # 仓库管理
│   │   ├── graph.rs         # 图操作 + 自动维护
│   │   ├── object.rs        # Git式对象
│   │   ├── parser.rs        # Markdown解析 + [[链接]]提取
│   │   ├── indexer.rs       # 自动索引
│   │   └── watcher.rs       # 文件监听
│   │
│   ├── ai/                  # **AI核心模块**
│   │   ├── mod.rs
│   │   ├── rag.rs           # RAG检索增强生成
│   │   ├── linker.rs        # 自动链接发现
│   │   ├── generator.rs     # 节点自动生成
│   │   ├── workflow.rs      # AI工作流引擎
│   │   ├── embeddings.rs    # 向量嵌入
│   │   └── llm.rs           # LLM接口
│   │
│   ├── storage/             # 存储层
│   │   ├── mod.rs
│   │   ├── oxigraph.rs      # Oxigraph操作
│   │   ├── sqlite.rs        # SQLite元数据
│   │   ├── file.rs          # 文件系统
│   │   └── vector.rs        # 向量存储
│   │
│   ├── vcs/                 # 版本控制（混合架构：Git + 图历史）
│   │   ├── mod.rs           # 版本控制抽象
│   │   ├── git.rs           # Git集成（文件存储、差异计算）
│   │   ├── commit.rs        # 提交（支持多父）
│   │   ├── graph_history.rs # 图历史追踪、推导链
│   │   ├── rollback.rs      # 回退机制
│   │   └── pack.rs          # Pack文件
│   │
│   ├── sync/                # 同步协议
│   │   ├── mod.rs
│   │   ├── transport.rs     # 传输
│   │   ├── push.rs          # 推送
│   │   ├── fetch.rs         # 获取
│   │   ├── clone.rs         # 克隆
│   │   ├── conflict.rs      # 冲突
│   │   └── remote.rs        # 远程仓库
│   │
│   ├── api/                 # HTTP API
│   │   ├── mod.rs
│   │   ├── routes/          # 路由定义
│   │   ├── handlers/        # 请求处理
│   │   ├── models/          # API模型
│   │   ├── websocket.rs     # WebSocket
│   │   └── auth.rs          # 认证
│   │
│   ├── cli/                 # CLI命令
│   │   ├── mod.rs
│   │   ├── commands/        # 极简命令集
│   │   └── output/          # 格式化输出
│   │
│   └── utils/               # 工具函数
│       └── mod.rs
│
├── tests/
│   ├── integration/
│   └── e2e/
│
├── docs/
│   ├── 项目文档.md           # 需求文档
│   ├── 实现方案大纲.md       # 本文档
│   └── api/
│       └── openapi.yaml     # OpenAPI规范
│
├── scripts/
│   ├── build.sh
│   └── test.sh
│
└── .memexia/                # 系统保留目录
```

---

## 十三、验收标准与实现路径

> **设计说明**: 本章节按照功能模块组织，每个阶段包含具体验收标准和测试用例。实现应严格按照此路径进行。

---

        ### 13.1 Phase 1: 基础架构与文件即节点

> **目标**: 核心架构搭建、文件自动转节点、链接语法解析

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W1 | 仓库初始化系统 | `repository.rs`, `memexia init` | ✅ 创建 `.memexia/` 目录结构<br>✅ 创建 `meta.json` 元数据<br>✅ 自动检测父目录 `.memexia` |
| W1-W2 | 存储层抽象 | `storage/mod.rs`, `oxigraph.rs` | ✅ Oxigraph 图数据库初始化<br>✅ 节点/边的 CRUD 操作<br>✅ SPARQL 查询支持<br>✅ N-Quads 格式导入导出 |
| W2-W3 | Markdown解析器 | `parser.rs` | ✅ 解析 `[[目标\|类型]]` 语法<br>✅ 提取 YAML frontmatter 元数据<br>✅ 提取 tags 和文件类型 |
| W3-W4 | 文件监听与索引 | `watcher.rs`, `indexer.rs` | ✅ 监听文件变更（notify库）<br>✅ 文件变更自动触发图更新<br>✅ 自动创建/更新节点 |

#### 验收测试用例

```bash
# TC-001: 仓库初始化
$ memexia init my-knowledge
# 预期:
# - 创建 my-knowledge/.memexia/ 目录
# - 创建 my-knowledge/.memexia/meta.json
# - 创建 my-knowledge/.memexia/graph.nq
# - 创建 my-knowledge/.git/ 目录

# TC-002: 自动节点创建
$ echo "# 自由意志\n\n自由意志是..." > my-knowledge/notes/free_will.md
$ memexia status
# 预期: 检测到新节点 free_will.md，节点加入暂存区

# TC-003: 链接语法解析
$ echo "[[决定论\|矛盾]]" >> my-knowledge/notes/free_will.md
# 预期:
# - 创建/查找决定论节点
# - 创建 Contradicts 类型的边
# - 边包含 strength=1.0, source="explicit"

# TC-004: 关系类型支持
$ echo "[[意识\|属于:0.95:意识是心灵哲学核心]]" >> my-knowledge/notes/free_will.md
# 预期:
# - 边的 relationType = "BelongsTo"
# - 边的 strength = 0.95
# - 边的 description = "意识是心灵哲学核心"
```

#### Phase 1 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia init [PATH]` | ✅ | 初始化新仓库 |
| `memexia clone <URL> [PATH]` | ✅ | 克隆远程仓库 |
| `memexia status` | ✅ | 查看工作区状态（自动检测仓库） |
| `memexia add <FILE...>` | ✅ | 暂存文件/节点 |

---

### 13.2 Phase 2: 版本控制与图历史

> **目标**: Git集成、提交系统、差异存储、历史查看

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W5 | Git文件存储集成 | `vcs/git.rs`, `object.rs` | ✅ 复用 `.git/` 存储文件<br>✅ Git式对象模型（blob/tree/commit）<br>✅ 文件差异计算 |
| W6 | 提交系统 | `vcs/commit.rs` | ✅ `memexia commit -m "msg"` 正常工作<br>✅ 提交记录包含图快照哈希<br>✅ `memexia commit --amend` 修改提交 |
| W6-W7 | 图历史追踪 | `vcs/graph_history.rs` | ✅ 记录节点变化历史<br>✅ 记录边创建/删除历史<br>✅ 推导链存储 |
| W7-W8 | 回退机制 | `vcs/rollback.rs` | ✅ `memexia rollback <COMMIT>` 软回退<br>✅ `memexia rollback --hard` 硬回退<br>✅ `memexia revert <COMMIT>` 创建新提交回退 |

#### 验收测试用例

```bash
# TC-005: 完整提交流程
$ cd my-knowledge
$ memexia add notes/free_will.md
$ memexia commit -m "添加自由意志概念"
# 预期:
# - 生成 commit hash
# - graph.nq 更新
# - .git/objects/ 创建对应对象
# - 历史记录新增一条

# TC-006: 历史查看
$ memexia history
# 预期: 显示提交历史（类似 git log）
$ memexia history --oneline
# 预期: 简洁格式显示
$ memexia history --graph
# 预期: 图形化展示
$ memexia history notes/free_will.md
# 预期: 显示文件的变更历史

# TC-007: 回退操作
$ memexia rollback abc123 --soft
# 预期: 暂存区保留，工作区回退
$ memexia rollback abc123 --hard
# 预期: 丢弃所有变更，完全回退

# TC-008: Revert
$ memexia revert abc123
# 预期: 创建新提交反向变更，不改变历史

# TC-009: 差异存储验证
# 多次提交后检查 .memexia/history/
# 预期: 存储差异而非全量快照（每隔N次全量）
```

#### Phase 2 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia commit -m "<MSG>"` | ✅ | 提交变更 |
| `memexia commit --amend` | ✅ | 修改最后一次提交 |
| `memexia reset [--soft\|--hard]` | ✅ | 重置工作区 |
| `memexia log [--oneline\|--graph]` | ✅ | 查看提交历史 |
| `memexia show <COMMIT>` | ✅ | 查看提交详情 |
| `memexia diff [COMMIT]` | ✅ | 查看差异 |
| `memexia history` | ✅ | 查看图历史 |
| `memexia history --oneline` | ✅ | 简洁格式 |
| `memexia history --graph` | ✅ | 图形化展示 |
| `memexia rollback <COMMIT>` | ✅ | 回退到某次提交 |
| `memexia rollback --hard` | ✅ | 硬回退 |
| `memexia rollback --soft` | ✅ | 软回退 |
| `memexia revert <COMMIT>` | ✅ | 创建新提交回退 |

---

### 13.3 Phase 3: 图谱查询与链接管理

> **目标**: 图谱展示、SPARQL查询、边操作

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W9 | 图谱展示命令 | `graph.rs`, CLI命令 | ✅ `memexia graph show --json` 输出节点和边<br>✅ `memexia graph dot` 输出DOT格式<br>✅ `memexia graph stats` 显示统计信息 |
| W10 | SPARQL查询 | `graph.rs` | ✅ `memexia graph query "<SPARQL>"` 执行查询<br>✅ 支持所有预定义关系类型<br>✅ 支持变量绑定和结果格式化 |
| W10-W11 | 路径查询 | `graph.rs` | ✅ `memexia graph path <NODE1> <NODE2>` 查找路径<br>✅ BFS/DFS 路径搜索<br>✅ 返回最短路径 |

#### 验收测试用例

```bash
# TC-010: 图谱JSON输出
$ memexia graph show --json
# 预期输出:
# {
#   "nodes": [
#     {"id": "urn:memexia:file:notes/free_will.md", "type": "Concept", ...}
#   ],
#   "edges": [
#     {"from": "...", "to": "...", "type": "Contradicts", "strength": 1.0, ...}
#   ]
# }

# TC-011: 关系类型支持验证
# 验证以下关系类型正常工作:
# - Contains/BelongsTo (结构关系)
# - DerivesFrom/LeadsTo (因果/推导关系)
# - Supports/Contradicts/Refines (论证关系)
# - RelatedTo/SimilarTo/OppositeOf (语义关系)
# - References/Cites (参考关系)
# - DependsOn/EvolvesFrom/EvolvesInto (元关系)

# TC-012: SPARQL查询
$ memexia graph query "
PREFIX memexia: <http://memexia.org/schema/>
SELECT ?node WHERE {
  ?node memexia:type \"Concept\" .
}
"
# 预期: 返回所有 Concept 类型的节点

# TC-013: 路径查询
$ memexia graph path "自由意志" "决定论"
# 预期: 返回两节点间的路径，或 "无路径" 提示

# TC-014: 文件关联查询
$ memexia file notes/free_will.md
# 预期: 显示文件对应的节点信息
$ memexia file links notes/free_will.md
# 预期: 显示文件中的所有链接
$ memexia file backlinks notes/free_will.md
# 预期: 显示指向该文件的所有反向链接

# TC-015: 手动创建链接
$ memexia link create notes/a.md notes/b.md --type RelatedTo
# 预期: 手动创建链接，source="user"
```

#### Phase 3 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia graph show [--json]` | ✅ | 输出图谱结构 |
| `memexia graph dot` | ✅ | 输出DOT格式 |
| `memexia graph query "<SPARQL>"` | ✅ | SPARQL查询 |
| `memexia graph stats` | ✅ | 图谱统计信息 |
| `memexia graph path <NODE1> <NODE2>` | ✅ | 查找两节点间的路径 |
| `memexia file <PATH>` | ✅ | 查看文件对应的节点信息 |
| `memexia file links <PATH>` | ✅ | 查看文件中的链接 |
| `memexia file backlinks <PATH>` | ✅ | 查看文件的反向链接 |
| `memexia link create <FILE> <TARGET> --type <TYPE>` | ✅ | 手动创建链接 |

---

### 13.4 Phase 4: 同步协议与远程协作

> **目标**: 差异同步、冲突检测、远程操作

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W13 | 同步传输协议 | `sync/transport.rs`, MessagePack | ✅ 自定义同步协议（0x4D58魔数）<br>✅ HTTP/WebSocket传输支持<br>✅ 消息类型：Hello/Fetch/Push/SyncDiff/ConflictNotify/SyncComplete |
| W14 | 拉取/推送操作 | `sync/fetch.rs`, `sync/push.rs` | ✅ `memexia fetch [REMOTE]` 拉取远程变更<br>✅ `memexia push <REMOTE>` 推送本地变更<br>✅ `memexia pull <REMOTE>` 拉取并合并 |
| W14-W15 | 冲突检测与解决 | `sync/conflict.rs` | ✅ 节点冲突：3-way merge<br>✅ 边冲突：AI分析关系合理性<br>✅ 逻辑矛盾：推导链回溯<br>✅ 冲突解决：`memexia sync resolve <CONFLICT>` |
| W15-W16 | 远程协作 | `sync/remote.rs`, fork/mr命令 | ✅ `memexia remote add/list/remove`<br>✅ `memexia fork <URL>` Fork仓库<br>✅ `memexia mr create/list/review/accept` 合并请求 |

#### 验收测试用例

```bash
# TC-016: 远程仓库管理
$ memexia remote add origin https://server/repo.git
$ memexia remote -v
# 预期: 远程仓库配置正确保存

# TC-017: 差异同步
$ memexia sync status
# 预期: 显示同步状态（ahead/behind/both）
$ memexia sync conflicts
# 预期: 列出所有冲突

# TC-018: 冲突解决流程
$ memexia sync resolve <CONFLICT_ID> --strategy auto
# 预期: 自动解决可合并的冲突
$ memexia sync resolve <CONFLICT_ID> --strategy manual
# 预期: 进入手动解决流程

# TC-019: 合并请求流程
$ memexia merge-request create --title "添加相容论"
# 预期: 创建MR，返回MR ID
$ memexia mr list
# 预期: 列出所有MR
$ memexia mr review <MR_ID>
# 预期: 审查MR，显示差异
$ memexia mr accept <MR_ID>
# 预期: 接受MR并合并
```

#### Phase 4 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia remote add <NAME> <URL>` | ✅ | 添加远程仓库 |
| `memexia remote -v` | ✅ | 列出远程仓库 |
| `memexia fetch [REMOTE]` | ✅ | 获取远程更新 |
| `memexia push <REMOTE>` | ✅ | 推送所有变更到远程 |
| `memexia pull <REMOTE>` | ✅ | 拉取并合并 |
| `memexia sync status` | ✅ | 同步状态 |
| `memexia sync conflicts` | ✅ | 查看冲突 |
| `memexia sync resolve <CONFLICT>` | ✅ | 解决冲突 |
| `memexia fork <REMOTE_URL>` | ✅ | Fork远程仓库到本地 |
| `memexia merge-request create` | ✅ | 创建合并请求 |
| `memexia mr list` | ✅ | 列出合并请求 |
| `memexia mr review <MR_ID>` | ✅ | 审查合并请求 |
| `memexia mr accept <MR_ID>` | ✅ | 接受合并请求 |
| `memexia comment add <FILE> --body "<TEXT>"` | ✅ | 添加评论 |
| `memexia comment list <FILE>` | ✅ | 列出评论 |
| `memexia access add <USER> --read\|write\|admin` | ✅ | 添加协作者 |

---

### 13.5 Phase 5: RAG与AI基础功能

> **目标**: RAG问答、向量嵌入、自动链接建议

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W17-W18 | 向量嵌入系统 | `ai/embeddings.rs`, `storage/vector.rs` | ✅ 生成节点内容的向量表示<br>✅ FAISS/ChromaDB 向量索引<br>✅ 支持本地/远程嵌入模型 |
| W18-W19 | RAG问答系统 | `ai/rag.rs` | ✅ `memexia ask "<QUESTION>"` 基于图谱问答<br>✅ 上下文检索与组装<br>✅ `memexia ask --context <FILE> "<QUESTION>"` 指定上下文 |
| W19-W20 | 自动链接发现 | `ai/linker.rs` | ✅ `memexia ai link suggest [FILE]` AI推荐潜在链接<br>✅ `memexia ai link auto [--dry-run]` 自动创建高置信度链接<br>✅ 链接置信度计算 |

#### 验收测试用例

```bash
# TC-020: 向量索引构建
$ memexia reindex --vector
# 预期: 为所有节点生成向量，存入向量索引

# TC-021: RAG问答
$ memexia ask "自由意志和决定论有什么关系？"
# 预期:
# - 检索相关节点（基于向量相似度）
# - 组装上下文
# - 调用LLM生成回答
# - 回答引用图谱中的关系

$ memexia ask --context notes/free_will.md "相容论是什么？"
# 预期: 仅基于指定文件上下文回答

# TC-022: 自动链接建议
$ memexia ai link suggest notes/free_will.md
# 预期: 返回建议的链接列表（带置信度）
# [
#   {"target": "神经科学", "type": "RelatedTo", "confidence": 0.85},
#   {"target": "物理学", "type": "RelatedTo", "confidence": 0.72}
# ]

# TC-023: 自动创建链接
$ memexia ai link auto --dry-run
# 预期: 显示将自动创建的链接（不实际创建）
$ memexia ai link auto
# 预期: 创建置信度 > 0.9 的链接
```

#### Phase 5 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia ask "<QUESTION>"` | ✅ | 基于图谱的智能问答 |
| `memexia ask --context <FILE> "<QUESTION>"` | ✅ | 基于特定文件的问答 |
| `memexia ai link suggest [FILE]` | ✅ | AI推荐潜在链接 |
| `memexia ai link auto [--dry-run]` | ✅ | 自动创建高置信度链接 |
| `memexia ai link review` | ✅ | 审查AI建议的链接 |
| `memexia ai search "<QUERY>"` | ✅ | 语义搜索 |
| `memexia ai search --similar <FILE>` | ✅ | 查找相似节点 |

---

### 13.6 Phase 6: AI推导链与可信度

> **目标**: AI生成节点可追溯、可信度计算

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W21-W22 | 推导链存储 | `ai/*.rs`, `storage/*.rs` | ✅ AI生成节点关联推导链<br>✅ 推导链元数据存储（model, prompt, confidence）<br>✅ 推导步骤记录 |
| W22-W23 | 可信度计算 | `ai/credibility.rs` | ✅ 节点可信度计算公式实现<br>✅ 推导链衰减系数（0.9^length）<br>✅ 反证关系影响计算 |
| W23-W24 | 推导链操作 | CLI命令 | ✅ `memexia chain list` 列出推导链<br>✅ `memexia chain show <ID>` 显示详情<br>✅ `memexia chain trace <NODE_ID>` 追溯路径<br>✅ `memexia credibility <NODE_ID>` 查看可信度 |

#### 验收测试用例

```bash
# TC-024: AI生成节点推导链
$ memexia ai generate notes/free_will.md
# 预期:
# - 生成新节点
# - 创建推导链记录
# - 推导链包含：model, prompt, confidence, steps

# TC-025: 推导链操作
$ memexia chain list
# 预期: 列出所有推导链（暂存区）
# [
#   {"id": "uuid-001", "type": "generation", "model": "gpt-4", "confidence": 0.87},
#   {"id": "uuid-002", "type": "inference", "model": "claude", "confidence": 0.92}
# ]

$ memexia chain show uuid-001
# 预期: 显示推导链详情（steps, source_nodes, result）

$ memexia chain trace notes/new_node.md
# 预期: 可视化追溯推理路径

# TC-026: 推导链提交
$ memexia chain commit uuid-001 -m "AI生成的相容论解释"
# 预期: 推导链提交到历史

$ memexia chain discard uuid-002
# 预期: 丢弃推导链（不进入历史）

# TC-027: 可信度计算
$ memexia credibility notes/ai_generated.md
# 预期: 返回可信度分数及计算依据
# {
#   "confidence": 0.73,
#   "factors": {
#     "base": 1.0,
#     "chain_length_decay": 0.81,
#     "source_confidence": 0.9,
#     "model_weight": 1.0,
#     "contradiction_ratio": 0.0
#   }
# }

$ memexia credibility --low
# 预期: 列出所有低可信度节点（<0.5）
```

#### Phase 6 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia ai generate <FILE>` | ✅ | 基于文件延伸新思想 |
| `memexia ai generate --count 3 <FILE>` | ✅ | 生成多个新节点 |
| `memexia ai expand <TOPIC>` | ✅ | 展开主题 |
| `memexia chain list` | ✅ | 列出暂存区推导链 |
| `memexia chain show <CHAIN_ID>` | ✅ | 显示推导链详情 |
| `memexia chain find <NODE_ID>` | ✅ | 查找某节点的推导链 |
| `memexia chain trace <NODE_ID>` | ✅ | 追溯推理路径（可视化） |
| `memexia chain verify <NODE_ID>` | ✅ | 验证可信度 |
| `memexia chain stats` | ✅ | 推导链统计 |
| `memexia chain discard <CHAIN_ID>` | ✅ | 丢弃推导链 |
| `memexia chain commit <CHAIN_ID> -m "..."` | ✅ | 提交推导链到历史 |
| `memexia credibility <NODE_ID>` | ✅ | 查看节点可信度 |
| `memexia credibility --low` | ✅ | 查看低可信度节点 |

---

### 13.7 Phase 7: AI工作流引擎

> **目标**: 插件化工作流引擎、7种工作流类型

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W25-W26 | 插件系统架构 | `ai/plugins/*.rs` | ✅ `AiWorkflowPlugin` trait 定义<br>✅ `PluginManager` 插件注册与发现<br>✅ 插件配置验证 |
| W26-W27 | 内置工作流实现 | `ai/workflow.rs` | ✅ 探索性工作流 (exploration)<br>✅ 论证分析工作流 (argument-analysis)<br>✅ 知识补全工作流 (knowledge-completion)<br>✅ 推导性工作流 (derivation) |
| W27-W28 | 高级工作流 | `ai/workflow.rs` | ✅ 综合工作流 (synthesis)<br>✅ 批判工作流 (critique)<br>✅ 定期回顾工作流 (review)<br>✅ 工作流状态机实现 |

#### 验收测试用例

```bash
# TC-028: 工作流启动
$ memexia ai workflow start exploration --from notes/free_will.md
# 预期: 启动探索性工作流
# 返回: workflow_id, 状态 "pending" -> "running"

$ memexia ai workflow list
# 预期: 列出所有运行中的工作流
# [
#   {"id": "wf-001", "type": "exploration", "status": "running", "progress": 45}
# ]

# TC-029: 工作流控制
$ memexia ai workflow logs wf-001
# 预期: 显示工作流执行日志
$ memexia ai workflow stop wf-001
# 预期: 停止工作流，状态变为 "paused"
$ memexia ai workflow export wf-001 --format json
# 预期: 导出工作流结果

# TC-030: 论证分析工作流
$ memexia ai workflow start argument-analysis notes/free_will.md
# 预期: 分析论证结构
# 返回: 前提、结论、支持、反驳列表

# TC-031: 知识补全工作流
$ memexia ai workflow start knowledge-completion
# 预期: 识别图谱空白，建议待探索方向

# TC-032: 推导性工作流
$ memexia ai workflow start derivation --from notes/free_will.md
# 预期: 严格推导 A -> B -> C，记录每步逻辑依据

# TC-033: 综合工作流
$ memexia ai workflow start synthesis --nodes id1,id2,id3
# 预期: 综合多个节点形成新观点

# TC-034: 批判工作流
$ memexia ai workflow start critique --target notes/free_will.md
# 预期: 寻找反例和漏洞，生成批判报告

# TC-035: 定期回顾工作流
$ memexia ai workflow start review --days 7
# 预期: 分析近期修改，发现潜在连接

# TC-036: 插件管理
$ memexia serve plugin list
# 预期: 列出已安装的插件
$ memexia serve plugin enable exploration
# 预期: 启用插件
$ memexia serve plugin disable critique
# 预期: 禁用插件
```

#### Phase 7 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia ai workflow start <TYPE> --from <FILE>` | ✅ | 启动工作流 |
| `memexia ai workflow list` | ✅ | 列出工作流 |
| `memexia ai workflow logs <ID>` | ✅ | 查看日志 |
| `memexia ai workflow stop <ID>` | ✅ | 停止工作流 |
| `memexia ai workflow export <ID> --format json` | ✅ | 导出结果 |
| `memexia serve plugin list` | ✅ | 列出插件 |
| `memexia serve plugin enable <PLUGIN>` | ✅ | 启用插件 |
| `memexia serve plugin disable <PLUGIN>` | ✅ | 禁用插件 |

---

### 13.8 Phase 8: 三层架构与控制层

> **目标**: 可控AI思考脚手架、人机协同

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W29-W30 | 控制层实现 | `ai/control.rs` | ✅ 价值观约束管理<br>✅ 节点审批流程<br>✅ AI指导功能 |
| W30-W31 | 控制层命令 | CLI命令 | ✅ `memexia ai constraint add/list/remove`<br>✅ `memexia ai approve/reject/pending`<br>✅ `memexia ai guide clear` |
| W31-W32 | 结构思考层完善 | `ai/structured.rs` | ✅ 节点级别回退<br>✅ 推导链回退<br>✅ 步骤级回退 |

#### 验收测试用例

```bash
# TC-037: 价值观约束
$ memexia ai constraint add "避免过于乐观的结论"
$ memexia ai constraint list
# 预期: 约束列表显示添加的约束

# TC-038: 节点审批
$ memexia ai pending
# 预期: 显示待审批的AI生成节点
$ memexia ai approve <NODE_ID>
# 预期: 批准节点，合并到主图谱
$ memexia ai reject <NODE_ID> --reason "不符合逻辑"
# 预期: 拒绝节点，标记为 rejected

# TC-039: AI指导
$ memexia ai guide "请从相容论视角分析"
# 预期: 设置思考方向，后续AI请求使用该指导
$ memexia ai guide clear
# 预期: 清除指导

# TC-040: 节点审查
$ memexia ai review <NODE_ID>
# 预期: 审查节点推导链，显示可信度因素
$ memexia ai review --all
# 预期: 审查所有AI生成节点

# TC-041: 推导链回退
$ memexia rollback chain <CHAIN_ID>
# 预期: 回退整个推导链
$ memexia rollback chain <CHAIN_ID> --step 3
# 预期: 回退到第3步
```

#### Phase 8 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia ai constraint add "<TEXT>"` | ✅ | 添加价值观约束 |
| `memexia ai constraint list` | ✅ | 列出约束 |
| `memexia ai constraint remove <ID>` | ✅ | 移除约束 |
| `memexia ai approve <NODE_ID>` | ✅ | 批准节点 |
| `memexia ai reject <NODE_ID> --reason "..."` | ✅ | 拒绝节点 |
| `memexia ai pending` | ✅ | 查看待审批列表 |
| `memexia ai guide "<TEXT>"` | ✅ | 设置思考方向 |
| `memexia ai guide clear` | ✅ | 清除指导 |
| `memexia ai review <NODE_ID>` | ✅ | 审查节点推导链 |
| `memexia ai review --all` | ✅ | 审查所有AI节点 |
| `memexia rollback chain <CHAIN_ID>` | ✅ | 回退整个推导链 |
| `memexia rollback chain <CHAIN_ID> --step 3` | ✅ | 回退到第几步 |
| `memexia rollback node <NODE_ID>` | ✅ | 回退单个节点 |

---

### 13.9 Phase 9: API服务与发布

> **目标**: HTTP API、WebSocket、完整文档

| 周次 | 任务 | 交付物 | 验收标准 |
|------|------|--------|----------|
| W33-W34 | HTTP API服务器 | `api/mod.rs`, `api/routes/*.rs` | ✅ 所有CLI命令对应API端点<br>✅ RESTful风格设计<br>✅ 认证与授权 |
| W34-W35 | WebSocket实时通信 | `api/websocket.rs` | ✅ 工作流状态实时推送<br>✅ 同步状态实时更新 |
| W35-W36 | 文档与发布 | `docs/`, `Cargo.toml` | ✅ 完整API文档<br>✅ CLI帮助文档<br>✅ 发布到 crates.io |

#### API端点清单

| 方法 | 路径 | 对应命令 | 状态 |
|------|------|----------|------|
| **仓库** |||
| POST | `/api/v1/repos` | `init` | ✅ |
| GET | `/api/v1/repos/{id}` | - | ✅ |
| **文件** |||
| GET | `/api/v1/repos/{id}/files/{path}` | `file` | ✅ |
| **图谱** |||
| GET | `/api/v1/repos/{id}/graph` | `graph show` | ✅ |
| POST | `/api/v1/repos/{id}/graph/query` | `graph query` | ✅ |
| **AI** |||
| POST | `/api/v1/repos/{id}/ai/ask` | `ask` | ✅ |
| POST | `/api/v1/repos/{id}/ai/link/suggest` | `ai link suggest` | ✅ |
| POST | `/api/v1/repos/{id}/ai/generate` | `ai generate` | ✅ |
| POST | `/api/v1/repos/{id}/ai/workflow/start` | `ai workflow start` | ✅ |
| **版本控制** |||
| GET | `/api/v1/repos/{id}/commits` | `log` | ✅ |
| **历史与回退** |||
| GET | `/api/v1/repos/{id}/history` | `history` | ✅ |
| GET | `/api/v1/repos/{id}/chains` | `chain list` | ✅ |
| POST | `/api/v1/repos/{id}/rollback` | `rollback` | ✅ |
| **同步** |||
| POST | `/api/v1/repos/{id}/sync/push` | `push` | ✅ |
| POST | `/api/v1/repos/{id}/sync/pull` | `pull` | ✅ |
| GET | `/api/v1/repos/{id}/sync/status` | `sync status` | ✅ |

#### Phase 9 命令清单

| 命令 | 状态 | 说明 |
|------|------|------|
| `memexia serve [--port <PORT>]` | ✅ | 启动API服务器 |
| `memexia serve --daemon` | ✅ | 后台运行服务 |
| `memexia serve --host <IP>` | ✅ | 指定监听地址 |
| `memexia serve ai status` | ✅ | 查看AI服务连接状态 |
| `memexia serve ai test` | ✅ | 测试AI API连接 |
| `memexia config get <KEY>` | ✅ | 获取配置 |
| `memexia config set <KEY> <VALUE>` | ✅ | 设置配置 |
| `memexia config list` | ✅ | 列出所有配置 |
| `memexia config edit` | ✅ | 编辑配置文件 |

---

### 13.10 完整版本对照表

| 版本 | Phase | 目标 | 预计周次 |
|------|-------|------|----------|
| v0.1.0 | Phase 1 | 基础架构 + 文件即节点 | W1-W4 |
| v0.2.0 | Phase 2 | 版本控制与图历史 | W5-W8 |
| v0.3.0 | Phase 3 | 图谱查询与链接管理 | W9-W12 |
| v0.4.0 | Phase 4 | 同步协议与远程协作 | W13-W16 |
| v0.5.0 | Phase 5-6 | RAG + AI推导链 | W17-W24 |
| v0.6.0 | Phase 7 | AI工作流引擎 | W25-W28 |
| v0.7.0 | Phase 8 | 三层架构与控制层 | W29-W32 |
| v1.0.0 | Phase 9 | API服务与发布 | W33-W36 |

---

### 13.11 测试覆盖率要求

| 阶段 | 单元测试 | 集成测试 | 端到端测试 |
|------|----------|----------|------------|
| Phase 1-3 | ≥70% | ≥50% | 核心流程 |
| Phase 4-6 | ≥75% | ≥60% | 完整流程 |
| Phase 7-9 | ≥80% | ≥70% | 全覆盖 |

### 13.12 发布检查清单

- [ ] 所有验收测试用例通过
- [ ] 测试覆盖率达标
- [ ] 代码格式化 (cargo fmt)
- [ ] 静态检查通过 (cargo clippy)
- [ ] API文档完整 (Swagger/OpenAPI)
- [ ] CLI帮助文档准确
- [ ] README更新
- [ ] CHANGELOG编写
- [ ] 版本号更新

---

## 附录：用户体验流程示例

```
┌─────────────────────────────────────────────────────────────────────┐
│                     用户体验：写笔记=建图谱                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户操作                              系统自动                       │
│                                                                     │
│  1. 创建文件                                                         │
│     $ echo "# 自由意志\n\n自由意志是..." > notes/free_will.md        │
│     ↓                                                               │
│     系统自动：                                                       │
│     • 创建节点 uuid-1                                                │
│     • 解析内容，提取标签 ["哲学", "心灵哲学"]                          │
│     • 生成向量嵌入                                                   │
│     • 更新全文索引                                                   │
│                                                                     │
│  2. 添加带类型的链接                                                  │
│     $ cat >> notes/free_will.md "\n\n[[决定论|矛盾]]"                │
│     ↓                                                               │
│     系统自动：                                                       │
│     • 解析链接 [[决定论|矛盾]]                                        │
│     • 创建/查找决定论节点                                             │
│     • 创建边 uuid-1 --Contradicts--> uuid-2 (矛盾关系)               │
│     • 重新生成向量嵌入                                               │
│                                                                     │
│  3. 更多链接示例                                                     │
│     [[意识|属于]]   - 意识属于心灵哲学子主题                          │
│     [[实验证据|支持]] - 实验证据支持某种观点                          │
│     [[因果关系|推导]] - 因果关系可以推导出...                          │
│                                                                     │
│  4. 使用AI                                                           │
│     $ memexia ai ask "自由意志和决定论有什么关系？                     │
│     ↓                                                               │
│     AI回答：                                                         │
│     "根据图谱分析，自由意志和决定论之间存在矛盾关系..."                 │
│                                                                     │
│  5. AI自动探索                                                       │
│     $ memexia ai generate --count 3 notes/free_will.md              │
│     ↓                                                               │
│     AI生成：                                                         │
│     • "决定论：一个相关概念"                                          │
│     • "相容论：可能的调和观点"                                        │
│     • "实验证据：神经科学的发现"                                      │
│                                                                     │
│  6. 查看图谱                                                         │
│     $ memexia graph show --json                                     │
│     ↓                                                               │
│     {                                                              │
│       "nodes": [...],                                               │
│       "edges": [{"type": "Contradicts", ...}]                       │
│     }                                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

> **核心设计理念**: 用户只管写文件，AI自动维护图谱。
>
> 文档即节点，链接即带类型的连接，AI即引擎。
